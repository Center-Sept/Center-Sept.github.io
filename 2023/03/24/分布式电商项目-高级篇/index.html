<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="这是一个有成分的博客">
    <meta name="author" content="center-sept">
    
    <title>
        
            分布式电商项目-高级篇 |
        
        闲淤唠话
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"blogs.center-sept.top","root":"/","language":"zh-CN","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/favicon.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"这是一个有成分的博客。","header_transparent":true,"hitokoto":true},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="闲淤" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                闲淤唠话
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                关于
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">关于</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">分布式电商项目-高级篇</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">center-sept</span>
                        
                            <span class="author-label">Lv1</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2023-03-24 14:58:03</span>
        <span class="mobile">2023-03-24 14:58</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/ES/">ES</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>13.1k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>64 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h2><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>1.一个分布式的开源搜索和分析引擎，适用于所有类型的数据，包括文本，数字，地理空间，结构化和非结构化数据。</p>
<p>2.全文搜索属于最常见的需求，开源的 Elasticsearch是目前全文搜索引擎的首选。它可以快速地储存、搜索和分析海量数据。维基百科、Stack Overflow、Github 都采用它。</p>
<p><strong>3.Elastic 的底层是开源库 Lucene。但是，你没法直接用Lucene，必须自己写代码去调用它的接口。Elastic是 Lucene 的封装，提供了 REST API的操作接口，开箱即用。</strong></p>
<p>REST API:天然的跨平台。<br>官方文档:<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html" >https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html<i class="fas fa-external-link-alt"></i></a></p>
<p>官方中文:<a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/foreword_id.html" >https://www.elastic.co/guide/cn/elasticsearch/guide/current/foreword_id.html<i class="fas fa-external-link-alt"></i></a></p>
<p>社区中文:<br><a class="link"   target="_blank" rel="noopener" href="http://doc.codingdict.com/elasticsearch/0/" >http://doc.codingdict.com/elasticsearch/0/<i class="fas fa-external-link-alt"></i></a></p>
<h5 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h5><h6 id="1-index-索引"><a href="#1-index-索引" class="headerlink" title="1.index (索引)"></a>1.index (索引)</h6><p>动词，相当于MySQL中的insert</p>
<p>名词，相当于MySQL中的Database</p>
<h6 id="2-Type-类型"><a href="#2-Type-类型" class="headerlink" title="2.Type (类型)"></a>2.Type (类型)</h6><p>在Index(索引)中，可以定义一个或多个类型。类似于MySQL中的Table；每一种类型的数据放在一起；</p>
<h6 id="3-Document-文档"><a href="#3-Document-文档" class="headerlink" title="3.Document (文档)"></a>3.Document (文档)</h6><p>保存在某个索引（Index）下，某种类型（Type）的一个数据（Ducument），文档是JSON格式的，Document就像是MySQL中的某个Table里面的内容；</p>
<h6 id="4-倒排索引机制"><a href="#4-倒排索引机制" class="headerlink" title="4.倒排索引机制"></a>4.倒排索引机制</h6><p>分词：将整句拆分为单词</p>
<h4 id="Docker安装ES"><a href="#Docker安装ES" class="headerlink" title="Docker安装ES"></a>Docker安装ES</h4><h5 id="1-下载镜像文件"><a href="#1-下载镜像文件" class="headerlink" title="1.下载镜像文件"></a>1.下载镜像文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取ES镜像</span></span><br><span class="line">docker pull elasticsearch:7.4.2 </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拉取可视化镜像</span></span><br><span class="line">docker pull kibana:7.4.2</span><br></pre></td></tr></table></figure>

<h5 id="2-创建实例"><a href="#2-创建实例" class="headerlink" title="2.创建实例"></a>2.创建实例</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">创建配置文件夹</span></span><br><span class="line"> mkdir -p /mydata/elasticsearch/config</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">创建数据文件夹</span></span><br><span class="line"> mkdir -p /mydata/elasticsearch/data</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">创建插件文件夹</span></span><br><span class="line"> mkdir -p /mydata/elasticsearch/plugins</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">创建配置文件</span></span><br><span class="line"> echo &quot;http.host:0.0.0.0&quot; &gt;&gt; /mydata/elasticsearch/config/elasticsearch.yml</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">让任何用户都能读写</span></span><br><span class="line"> chmod -R 777 /mydata/elasticsearch/</span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">启动单机ES</span> </span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">9200 http通信端口  9300集群模式下通信端口</span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">-e <span class="string">&quot;discovery.type=single-node&quot;</span> 单节点运行</span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">ES_JAVA_OPTS=<span class="string">&quot;-Xms64m -Xmx128m&quot;</span> : 指定虚拟机使用内存大小，防止启动占用太多内存</span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml : 指定配置的路径</span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data :指定数据路径</span></span><br><span class="line"><span class="meta prompt_"> # </span><span class="language-bash">-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins  :指定插件路径</span></span><br><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \</span><br><span class="line">-e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx520m&quot;  \</span><br><span class="line">-v /mydata/elasticsearch/data:/usr/share/elasticsearch/data   \</span><br><span class="line">-v /mydata/elasticsearch/plugins:/usr/share/elasticsearch/plugins  \</span><br><span class="line">-v /mydata/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \</span><br><span class="line">-d elasticsearch:7.4.2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Docker安装Kibana"><a href="#Docker安装Kibana" class="headerlink" title="Docker安装Kibana"></a>Docker安装Kibana</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker run --name kibana \</span><br><span class="line">-e ELASTICSEARCH_URL=http://192.168.72.130:9200 \</span><br><span class="line">-p 5601:5601 \</span><br><span class="line">-d kibana:7.4.2</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果-e ELASTICSEARCH_URL=http://192.168.72.130:9200 没有效果,我们必须进入kibana容器中，修改kibana.yml 文件的内容</span></span><br><span class="line">cd ./config</span><br><span class="line">vi kibana.yml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">elasticsearch.hosts: [ “http://&#123;你的安装ES的ip地址&#125;:9200” ]</span></span><br></pre></td></tr></table></figure>

<h4 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h4><h5 id="cat-查看ES信息"><a href="#cat-查看ES信息" class="headerlink" title="_cat (查看ES信息)"></a>_cat (查看ES信息)</h5><p>1.使用Postman 对ES服务发送查询请求</p>
<p>GET &#x2F;_cat&#x2F;nodes： 查看所有节点</p>
<p>GET &#x2F;_cat&#x2F;health： 查看ES健康状态</p>
<p>GET &#x2F;_cat&#x2F;master： 查看主节点</p>
<p>GET &#x2F;_cat&#x2F;indices： 查看ES所有索引  就像MySQL的show databases</p>
<h5 id="put-amp-post新增数据"><a href="#put-amp-post新增数据" class="headerlink" title="put&amp;post新增数据"></a>put&amp;post新增数据</h5><p>1.使用postman 向ES服务期发送PUT请求</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">url：http<span class="punctuation">:</span><span class="comment">//192.168.72.130:9200/customer/external/1</span></span><br><span class="line">method：put</span><br><span class="line">body：</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tom&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">response<span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span> <span class="comment">// 索引</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span> <span class="comment">// 类型</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span> <span class="comment">// id</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="comment">// 版本号</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span> <span class="comment">// 结果 created:新建 ； updated：更新</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// 分片，集群参数</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="comment">// 并发控制字段，每次更新就会+1，用来做乐观锁</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span> <span class="comment">//主分片重新分配，如重启，就会变化</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>2.使用postman 向ES服务期发送POST请求</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">url：http<span class="punctuation">:</span><span class="comment">//192.168.72.130:9200/customer/external/1</span></span><br><span class="line">method：post</span><br><span class="line">body：</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tom&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">response<span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;_index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_version&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;successful&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_seq_no&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;_primary_term&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>注：PUT和POST区别</p>
<p>1.POST新增：如果不指定id，会自动生成id。指定id就会修改这个数据，并新增版本号</p>
<p>2.PUT可以新增也可以修改。PUT必须指定id；由于PUT需要指定id，我们一般都用来做修改操作，不指定id会报错。</p>
<h5 id="get查询数据-amp-乐观锁"><a href="#get查询数据-amp-乐观锁" class="headerlink" title="get查询数据&amp;乐观锁"></a>get查询数据&amp;乐观锁</h5><h6 id="get查询数据"><a href="#get查询数据" class="headerlink" title="get查询数据"></a>get查询数据</h6><p>查询直接使用get请求 &#x2F;{索引}&#x2F;{类型}&#x2F;{id}</p>
<h6 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h6><p>使用_seq_no 来确认版本号</p>
<p>1.乐观锁更新数据</p>
<p>url:<a class="link"   target="_blank" rel="noopener" href="http://192.168.72.130:9200/customer/external/1?if_seq_no=3&amp;if_primary_term=1" >http://192.168.72.130:9200/customer/external/1?if_seq_no=3&amp;if_primary_term=1<i class="fas fa-external-link-alt"></i></a></p>
<p>method:PUT或者POST</p>
<p>如果版本号不定义给定的条件，则出现以下结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;root_cause&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, required seqNo [3], primary term [1]. current document has seqNo [4] and primary term [1]&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zb_uJgoTTIS96jNeCk45xQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;version_conflict_engine_exception&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[1]: version conflict, required seqNo [3], primary term [1]. current document has seqNo [4] and primary term [1]&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index_uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zb_uJgoTTIS96jNeCk45xQ&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;shard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">409</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="put-amp-post修改数据"><a href="#put-amp-post修改数据" class="headerlink" title="put&amp;post修改数据"></a>put&amp;post修改数据</h5><p>方法1：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span>/_update</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;doc&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tms1&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>方法2：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST customer/external/<span class="number">1</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">   <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;Tms1&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">或者</span><br><span class="line">PUT customer/external/<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>1.异同</p>
<p>不同：POST操作会对比源文档数据，如果相同不会有什么操作，文档version不增加，PUT操作总会将数据重新保存并添加version版本；带_update对比元数据如果一样就不进行任何操作</p>
<p>看场景：</p>
<p>对于大并发更新，使用不带update;</p>
<p>对于大并发查询偶尔更新，带update;对比更新，重新计算分配规则。</p>
<h5 id="删除数据-amp-bulk批量操作"><a href="#删除数据-amp-bulk批量操作" class="headerlink" title="删除数据&amp;bulk批量操作"></a>删除数据&amp;bulk批量操作</h5><h6 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h6><p>可以直接删除索引和文档，但不能删除类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE customer/external/1</span><br></pre></td></tr></table></figure>

<h6 id="bulk批量操作"><a href="#bulk批量操作" class="headerlink" title="bulk批量操作"></a>bulk批量操作</h6><p>示例1：</p>
<p>1.登入kibana 控制台，点击Dev Tools，在console 输入框里输入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST /customer/external/_bulk</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;1&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jojo&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_id&quot;:&quot;2&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;jiji&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>2.结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span> <span class="comment">// 花费多少毫秒</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span> <span class="comment">// 是否有错误</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="comment">// 结果子项</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="comment">// index 表示保存操作</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;customer&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;external&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>示例2：</p>
<p>1.在控制台输入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST /_bulk</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125; </span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;My first blog post&quot;&#125;</span><br><span class="line">&#123;&quot;index&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;title&quot;:&quot;My sencond blog post&quot;&#125;</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;website&quot;,&quot;_type&quot;:&quot;blog&quot;,&quot;_id&quot;:&quot;123&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;title&quot;:&quot;My updated blog post&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>2.结果</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;took&quot;</span> <span class="punctuation">:</span> <span class="number">148</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;items&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;delete&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;not_found&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">404</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;create&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;index&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;_SBEJnYB0s8ja78yQIS4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;created&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">201</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;update&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;_index&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;website&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;blog&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;123&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_version&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;updated&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_shards&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;total&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;successful&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;failed&quot;</span> <span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_seq_no&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_primary_term&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;status&quot;</span> <span class="punctuation">:</span> <span class="number">200</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h6 id="导入客户银行客户样本测试数据"><a href="#导入客户银行客户样本测试数据" class="headerlink" title="导入客户银行客户样本测试数据"></a>导入客户银行客户样本测试数据</h6><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch/blob/master/docs/src/test/resources/accounts.json" >elasticsearch&#x2F;accounts.json at master · elastic&#x2F;elasticsearch (github.com)<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /bank/account/_bulk</span><br><span class="line">粘贴样本数据</span><br></pre></td></tr></table></figure>

<h4 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h4><h5 id="两种查询方式"><a href="#两种查询方式" class="headerlink" title="两种查询方式"></a>两种查询方式</h5><h6 id="SearchAPI"><a href="#SearchAPI" class="headerlink" title="SearchAPI"></a>SearchAPI</h6><p>ES支持两种基本方式检索：</p>
<ul>
<li><p>通过使用REST request URL 发送搜索参数（uri+检索参数）</p>
</li>
<li><p>通过使用REST request body 来发送它们（uri+请求体）</p>
</li>
</ul>
<h6 id="uri-检索参数"><a href="#uri-检索参数" class="headerlink" title="uri+检索参数"></a>uri+检索参数</h6><ol>
<li>GET bank&#x2F;_search</li>
</ol>
<p>检索bank下所有信息，包括type的和docs</p>
<ol start="2">
<li>GET bank&#x2F;_search?q&#x3D;*&amp;sort&#x3D;account_number:asc</li>
</ol>
<p>请求参数方式检索</p>
<p>默认返回10条记录</p>
<ol start="3">
<li>结果解析</li>
</ol>
<p>took：花费时间</p>
<p>time_out：是否超时</p>
<p>_shards：集群情况下的信息</p>
<p>hits：命中的记录</p>
<p>total ：总记录数</p>
<h6 id="uri-检索参数（QueryDSL方式）"><a href="#uri-检索参数（QueryDSL方式）" class="headerlink" title="uri+检索参数（QueryDSL方式）"></a>uri+检索参数（QueryDSL方式）</h6><p>1.在Kibana控制台输入以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;:[</span><br><span class="line">   &#123;&quot;account_number&quot;:&quot;asc&quot;&#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>query：查询条件</p>
<p>match_all：匹配所有</p>
<p>sort：排序条件</p>
<h5 id="QueryDSL基本使用-amp-match-all"><a href="#QueryDSL基本使用-amp-match-all" class="headerlink" title="QueryDSL基本使用&amp;match_all"></a>QueryDSL基本使用&amp;match_all</h5><p>1.在kibana 根据语法提示直接操作</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-search.html" >https://www.elastic.co/guide/en/elasticsearch/reference/current/getting-started-search.html<i class="fas fa-external-link-alt"></i></a> 官方操作实例</p>
<p>2.使用_source 后接 数组字符串，按需返回字段值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;: &#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;from&quot;:0,</span><br><span class="line">	&quot;size&quot;:5,</span><br><span class="line">	&quot;sort&quot;:[</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;account_number&quot;:&#123;</span><br><span class="line">			&quot;order&quot;:&quot;desc&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	],</span><br><span class="line">	&quot;_source&quot;: [&quot;banlance&quot;,&quot;firstname&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.demo</p>
<p>3.1 demo1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;: &#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.2  demo2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">	&quot;query&quot;:&#123;</span><br><span class="line">		&quot;match_all&quot;: &#123;&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&quot;from&quot;:0,</span><br><span class="line">	&quot;size&quot;:5,</span><br><span class="line">	&quot;sort&quot;:[</span><br><span class="line">		&#123;</span><br><span class="line">			&quot;account_number&quot;:&#123;</span><br><span class="line">			&quot;order&quot;:&quot;desc&quot;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="match全文检索"><a href="#match全文检索" class="headerlink" title="match全文检索"></a>match全文检索</h5><p>1.基本类型（非字符串），精确匹配</p>
<p>1.1 精确匹配demo</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;account_number&quot;: &quot;20&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2 模糊查询(全文检索)按照评分进行排序，会对检索条件进行分词匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;Kings&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="match-parase短语匹配"><a href="#match-parase短语匹配" class="headerlink" title="match_parase短语匹配"></a>match_parase短语匹配</h5><p>将需要匹配的值当成一个整体单词（不分词）进行检索</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_phrase&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;mill road&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="multi-match多字段匹配"><a href="#multi-match多字段匹配" class="headerlink" title="multi_match多字段匹配"></a>multi_match多字段匹配</h5><p>address 包含 mill 或者 Movico，city 包含 mill 或者 Movico</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;multi_match&quot;: &#123;</span><br><span class="line">      &quot;query&quot;: &quot;mill Movico&quot;,</span><br><span class="line">      &quot;fields&quot;: [&quot;address&quot;,&quot;city&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="bool复合查询"><a href="#bool复合查询" class="headerlink" title="bool复合查询"></a>bool复合查询</h5><p>bool 用来做复合查询：</p>
<p>复合语句可以合并任何其他查询语句，包括复合语句，了解这一点是很重要的。这就意味着，复合语句之间可以互相嵌套，可以表达非常复杂的逻辑。</p>
<p>must：必须达到must列举的所有条件</p>
<p>满足should指定的条件，则_scource得分高</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">     &quot;must&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">       &#125;&#125;,</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;gender&quot;: &quot;M&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ],</span><br><span class="line">     &quot;must_not&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;age&quot;: &quot;18&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ],</span><br><span class="line">     &quot;should&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;lastname&quot;: &quot;Wallace&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="filter-结果过滤"><a href="#filter-结果过滤" class="headerlink" title="filter (结果过滤)"></a>filter (结果过滤)</h5><p>并不是所有的查询都需要产生分数，特别是那些仅用于”filtering”（过滤）的文档。为了不计算分数Elasticsearch会自动检查场景并且优化查询的执行。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">     &quot;must&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">       &#125;&#125;,</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;gender&quot;: &quot;M&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ],</span><br><span class="line">     &quot;must_not&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;age&quot;: &quot;18&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ],</span><br><span class="line">     &quot;should&quot;: [</span><br><span class="line">       &#123;&quot;match&quot;: &#123;</span><br><span class="line">         &quot;lastname&quot;: &quot;Wallace&quot;</span><br><span class="line">       &#125;&#125;</span><br><span class="line">     ],</span><br><span class="line">     &quot;filter&quot;: &#123;&quot;range&quot;: &#123;</span><br><span class="line">       &quot;age&quot;: &#123;</span><br><span class="line">         &quot;gte&quot;: 18,</span><br><span class="line">         &quot;lte&quot;: 30</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;filter&quot;: &#123;</span><br><span class="line">        &quot;range&quot;: &#123;</span><br><span class="line">          &quot;age&quot;: &#123;</span><br><span class="line">            &quot;gte&quot;: 10,</span><br><span class="line">            &quot;lte&quot;: 20</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="term-查询"><a href="#term-查询" class="headerlink" title="term 查询"></a>term 查询</h5><p>和match一样。匹配某个属性值。全文检索字段用match，其他非text字段匹配用term。</p>
<ol>
<li>精确匹配数值</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;term&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;value&quot;: 28</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>keyword 精确匹配</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">       &quot;address.keyword&quot;: &quot;789 Madison Street&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注：数值类型使用term，文本字段使用match</strong></p>
<h5 id="aggregations-聚合分析"><a href="#aggregations-聚合分析" class="headerlink" title="aggregations 聚合分析"></a>aggregations 聚合分析</h5><p>聚合提供了从数据中分组和提取数据的能力。最简单的聚合方法大致等于SQL的GROUP BY和SQL的聚合函数。在Elasticsearch中，您有执行搜索返回hits(命中结果)，并且同时返回聚合结果，把一个响应的所有hits(命中结果)分隔开的能力。这是非常强大且有效的，您可以执行查询和多个聚合，并且在一次使用中得到各自的（任何一个的）返回结果，使用一次简洁和简化的API来避免网络往返。</p>
<p>搜索address中包含mill的所有人的年龄分布以及平均年龄，但不显示这些人的详情。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;address&quot;: &quot;mill&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;ageAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ageAvg&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;balanceAvg&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照年龄聚合，并且请求这些年龄端的这些人的平均薪资</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;ageAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 100</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;ageAvg&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查出所有年龄分布，并且这些年龄段中M（女士）的平均薪资和F（男士）的平均薪资以及这个年龄段的总体平均薪资</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET bank/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;ageAgg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;age&quot;,</span><br><span class="line">        &quot;size&quot;: 100</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;genderAgg&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;gender.keyword&quot;,</span><br><span class="line">            &quot;size&quot;: 10</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;aggs&quot;: &#123;</span><br><span class="line">            &quot;banlanceAvg&quot;: &#123;</span><br><span class="line">              &quot;avg&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;ageBalanceAvg&quot;: &#123;</span><br><span class="line">          &quot;avg&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;balance&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h4><h5 id="mapping创建"><a href="#mapping创建" class="headerlink" title="mapping创建"></a>mapping创建</h5><h6 id="什么是Mapping-映射-？"><a href="#什么是Mapping-映射-？" class="headerlink" title="什么是Mapping(映射)？"></a>什么是Mapping(映射)？</h6><p>Mapping是用来定义一个文档，以及它所包含的属性是如何存储和索引的。比如，使用mapping来定义：</p>
<ul>
<li><p>哪些字符串属性应该被看做是全文本属性。</p>
</li>
<li><p>哪些属性包含数字，日期或者地理位置。</p>
</li>
<li><p>文档中的所有属性是否都能被索引（_all配置）。</p>
</li>
<li><p>日期的格式。</p>
</li>
<li><p>自定义映射规则来执行动态添加属性。</p>
</li>
</ul>
<ol>
<li>查询映射</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_mapping</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建映射</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;email&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="添加新的字段映射"><a href="#添加新的字段映射" class="headerlink" title="添加新的字段映射"></a>添加新的字段映射</h5><p>使用 PUT &#x2F;my_index&#x2F;_mapping</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PUT /my-index/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;employee-id&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">      &quot;index&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="修改映射-amp-数据迁移"><a href="#修改映射-amp-数据迁移" class="headerlink" title="修改映射&amp;数据迁移"></a>修改映射&amp;数据迁移</h5><h6 id="更新映射"><a href="#更新映射" class="headerlink" title="更新映射"></a>更新映射</h6><p>对于已经存在的映射字段，我们不能更新。更新必须创建新的索引进行数据迁移。</p>
<h6 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h6><ol>
<li>查询之前的mapping数据，复制properties 中的数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /bank/_mapping</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建新的索引映射</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">PUT /newbank</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;account_number&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;address&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;age&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;balance&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;city&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;email&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;employer&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;firstname&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;gender&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;lastname&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">          &quot;keyword&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">            &quot;ignore_above&quot;: 256</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;state&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>迁移数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;bank&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;account&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;newbank&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="分词"><a href="#分词" class="headerlink" title="分词"></a>分词</h4><h5 id="分词-amp-安装ik分词"><a href="#分词-amp-安装ik分词" class="headerlink" title="分词&amp;安装ik分词"></a>分词&amp;安装ik分词</h5><h6 id="何为分词器？"><a href="#何为分词器？" class="headerlink" title="何为分词器？"></a>何为分词器？</h6><p>一个tokenizer(分词器)接收一个字符流，将之分割为独立的tokens(词元，通常是独立的单词)，然后输出tokens流。</p>
<p>例如，whitespace tokenizer遇到空白字符时分割文本。它会将文本”Quick brown fox!”分割为 [Quick,brown,fox!]。</p>
<p>该tokenizer（分词器）还负责记录各个term（词条）的顺序或position位置（用于phrase短语和word proximity 词近邻拆查询），以及term(词条)所代表的原始word(单词)的start（起始）和end（结束）的character offsets （字符偏移量）(用于高亮显示搜索的内容)。</p>
<p>Elasticsearch 提供了很多内置的分词器，可以用来构建custom analyzer (自定义分词器)</p>
<ol>
<li>使用分词器</li>
</ol>
<p>1.1 空格分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;whitespace&quot;,</span><br><span class="line">  &quot;text&quot;:     &quot;The quick brown fox.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2 标准分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;:     &quot;The quick brown fox.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.安装ik分词器</p>
<p>2.1 使用wget 下载 ik分词器</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.4.2/elasticsearch-analysis-ik-7.4.2.zip</span><br></pre></td></tr></table></figure>

<p>2.2 解压压缩包，放到挂载的plugins&#x2F;ik文件夹下</p>
<p>2.3 测试分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 使用标准分词器</span><br><span class="line">GET my-index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;text&quot;: [&quot;我是中国人&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># 使用ik_smart分词器</span><br><span class="line">GET my-index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;我是中国人&quot;]</span><br><span class="line">&#125;</span><br><span class="line"># 使用ik_max_word分词器</span><br><span class="line">GET my-index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">  &quot;text&quot;: [&quot;我是中国人&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="自定义扩展词库"><a href="#自定义扩展词库" class="headerlink" title="自定义扩展词库"></a>自定义扩展词库</h5><h6 id="为何需要自定义扩展词库？"><a href="#为何需要自定义扩展词库？" class="headerlink" title="为何需要自定义扩展词库？"></a>为何需要自定义扩展词库？</h6><p>有一些词汇，分词器中没有对应的，需要我们自己去添加到词库，然后分词器才能够识别。</p>
<h6 id="自定义词库"><a href="#自定义词库" class="headerlink" title="自定义词库"></a>自定义词库</h6><ol>
<li>使用nginx做静态文件重定向，需要安装nginx和启动，无需做nginx配置</li>
</ol>
<p>1.1 在html文件夹下，创建es文件夹，再然后创建fenci.txt文本，内容是你需要进行分词的词句。</p>
<p>1.2 访问<a class="link"   target="_blank" rel="noopener" href="http://p/es/fenci.txt%EF%BC%8C%E7%BD%91%E9%A1%B5%E8%83%BD%E6%89%93%E5%BC%80%E7%9C%8B%E5%88%B0%E5%86%85%E5%AE%B9%EF%BC%8C%E8%AF%B4%E6%98%8E%E8%83%BD%E8%AE%BF%E9%97%AE%E3%80%82" >http://p/es/fenci.txt，网页能打开看到内容，说明能访问。<i class="fas fa-external-link-alt"></i></a></p>
<p>1.3 配置ik分词器配置文件，在elasticsearch的挂载目录的plugins下，解压之后的ik文件夹下进入config 文件夹下的IKAnalyzer.cfg.xml配置文件，把<a class="link"   target="_blank" rel="noopener" href="http://p/es/fenci.txt%E9%85%8D%E7%BD%AE%E8%BF%9B%E5%8E%BB" >http://p/es/fenci.txt配置进去<i class="fas fa-external-link-alt"></i></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_dict&quot;&gt;&lt;/entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;http://192.168.72.130/es/fenci.txt&lt;/entry&gt; --&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>



<h4 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h4><h5 id="SpringBoot整合high-level-client"><a href="#SpringBoot整合high-level-client" class="headerlink" title="SpringBoot整合high-level-client"></a>SpringBoot整合high-level-client</h5><h6 id="java客户端"><a href="#java客户端" class="headerlink" title="java客户端"></a>java客户端</h6><ol>
<li>spring-data-elasticsearch-transport-api.jar （不兼容7.x，8以后废弃）</li>
</ol>
<p>通过9300（TCP）端口操作</p>
<p>以下通过9200 Http请求交互</p>
<ol start="2">
<li>JestClient</li>
</ol>
<p>非官方，更新慢</p>
<ol start="3">
<li>RestTemplate</li>
</ol>
<p>模拟发http请求，ES很多操作需要自己封装，麻烦</p>
<ol start="4">
<li>httpClient</li>
</ol>
<p>模拟发http请求，ES很多操作需要自己封装，麻烦</p>
<ol start="5">
<li>Elasticsearch-Rest-Client</li>
</ol>
<p>官方RestClient，封装了ES操作，API层次分明，上手简单。</p>
<h6 id="引入Elasticsearch-Rest-Client"><a href="#引入Elasticsearch-Rest-Client" class="headerlink" title="引入Elasticsearch-Rest-Client"></a>引入Elasticsearch-Rest-Client</h6><ol>
<li>引入maven依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改SpringBoot 默认版本，由于spring-boot-dependencies 中elasticsearch默认版本为&lt;elasticsearch.version&gt;6.4.3&lt;&#x2F;elasticsearch.version&gt;</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;elasticsearch.version&gt;7.4.2&lt;/elasticsearch.version&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>加入common 模块，配置服务发现，再配置ElasticSearch配置类，加入到Bean容器中。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">esRestClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;192.168.72.130&quot;</span>, <span class="number">9200</span>,</span><br><span class="line">                <span class="string">&quot;http&quot;</span>));</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用测试类，是否已经导入到容器中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperMallElasticsearchApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient esClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(esClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试保存"><a href="#测试保存" class="headerlink" title="测试保存"></a>测试保存</h5><ol>
<li>在配置类加上ES公共配置Options</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestOptions COMMON_OPTIONS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TOKEN</span> <span class="operator">=</span> <span class="string">&quot;CENTER_SEPT&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        RequestOptions.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> RequestOptions.DEFAULT.toBuilder();</span><br><span class="line"><span class="comment">//        builder.addHeader(&quot;Authorization&quot;, &quot;Bearer&quot; + TOKEN);</span></span><br><span class="line"><span class="comment">//        builder.setHttpAsyncResponseConsumerFactory(new HttpAsyncResponseConsumerFactory.HeapBufferedResponseConsumerFactory(30 * 1024 * 1024 * 1024));</span></span><br><span class="line">        COMMON_OPTIONS = builder.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RestHighLevelClient <span class="title function_">esRestClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RestClientBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> RestClient.builder(<span class="keyword">new</span> <span class="title class_">HttpHost</span>(<span class="string">&quot;192.168.72.130&quot;</span>, <span class="number">9200</span>,</span><br><span class="line">                <span class="string">&quot;http&quot;</span>));</span><br><span class="line">        <span class="type">RestHighLevelClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestHighLevelClient</span>(builder);</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在测试类，加入以下代码，测试保存。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperMallElasticsearchApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient esClient;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存index到es中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addIndex</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        indexRequest.id(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="comment">// 这是一种方式</span></span><br><span class="line">        <span class="comment">// indexRequest.source(&quot;userName&quot;,&quot;chaoren&quot;,&quot;age&quot;,&quot;18&quot;,&quot;gender&quot;,&quot;男&quot;);</span></span><br><span class="line">        <span class="comment">// 第二种方式</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setUserName(<span class="string">&quot;chaoren&quot;</span>);</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setGender(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">        indexRequest.source(string, XContentType.JSON);</span><br><span class="line">        <span class="comment">// 执行保存操作</span></span><br><span class="line">        <span class="type">IndexResponse</span> <span class="variable">index</span> <span class="operator">=</span> esClient.index(indexRequest, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">        System.out.println(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> String userName;</span><br><span class="line">        <span class="keyword">private</span> String gender;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(esClient);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试复杂检索"><a href="#测试复杂检索" class="headerlink" title="测试复杂检索"></a>测试复杂检索</h5><p>测试类加入以下内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">searchData</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 创建索引请求</span></span><br><span class="line">        <span class="type">SearchRequest</span> <span class="variable">searchRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchRequest</span>();</span><br><span class="line">        <span class="comment">// 指定索引</span></span><br><span class="line">        searchRequest.indices(<span class="string">&quot;bank&quot;</span>);</span><br><span class="line">        <span class="comment">// 指定DSL，索引条件</span></span><br><span class="line">        <span class="type">SearchSourceBuilder</span> <span class="variable">searchSourceBuilder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SearchSourceBuilder</span>();</span><br><span class="line">        <span class="comment">// 构造检索条件</span></span><br><span class="line">        <span class="comment">//searchSourceBuilder.query(QueryBuilders.matchAllQuery());</span></span><br><span class="line">        searchSourceBuilder.query(QueryBuilders.matchQuery(<span class="string">&quot;address&quot;</span>, <span class="string">&quot;mill&quot;</span>));</span><br><span class="line">        <span class="comment">// 聚合</span></span><br><span class="line">        <span class="comment">// 按照年龄的值分布进行聚合</span></span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.terms(<span class="string">&quot;ageAgg&quot;</span>).field(<span class="string">&quot;age&quot;</span>).size(<span class="number">10</span>));</span><br><span class="line">        <span class="comment">// 计算平均薪资</span></span><br><span class="line">        searchSourceBuilder.aggregation(AggregationBuilders.avg(<span class="string">&quot;balanceAvg&quot;</span>).field(<span class="string">&quot;balance&quot;</span>));</span><br><span class="line">        searchRequest.source(searchSourceBuilder);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行检索</span></span><br><span class="line">        <span class="type">SearchResponse</span> <span class="variable">search</span> <span class="operator">=</span> esClient.search(searchRequest, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">        System.out.println(search);</span><br><span class="line">        <span class="comment">// 分析结果</span></span><br><span class="line">        <span class="comment">// 获取所有命中的记录</span></span><br><span class="line">        <span class="type">SearchHits</span> <span class="variable">hits</span> <span class="operator">=</span> search.getHits();</span><br><span class="line">        SearchHit[] searchHit = hits.getHits();</span><br><span class="line">        <span class="keyword">for</span> (SearchHit documentFields : searchHit) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sourceAsString</span> <span class="operator">=</span> documentFields.getSourceAsString();</span><br><span class="line">            <span class="type">Account</span> <span class="variable">account</span> <span class="operator">=</span> JSON.parseObject(sourceAsString, Account.class);</span><br><span class="line">            System.out.println(account);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 分析聚合信息</span></span><br><span class="line">        <span class="type">Aggregations</span> <span class="variable">aggregations</span> <span class="operator">=</span> search.getAggregations();</span><br><span class="line"><span class="comment">//        for (Aggregation aggregation : aggregations) &#123;</span></span><br><span class="line"><span class="comment">//            System.out.println(&quot;当前聚合：&quot;+aggregation.getName());</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="type">Terms</span> <span class="variable">ageAgg</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;ageAgg&quot;</span>);</span><br><span class="line">        List&lt;? <span class="keyword">extends</span> <span class="title class_">Terms</span>.Bucket&gt; buckets = ageAgg.getBuckets();</span><br><span class="line">        <span class="keyword">for</span> (Terms.Bucket bucket : buckets) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">keyAsString</span> <span class="operator">=</span> bucket.getKeyAsString();</span><br><span class="line">            System.out.println(<span class="string">&quot;年龄：&quot;</span> + keyAsString);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Avg</span> <span class="variable">balanceAvg</span> <span class="operator">=</span> aggregations.get(<span class="string">&quot;balanceAvg&quot;</span>);</span><br><span class="line">        <span class="type">double</span> <span class="variable">value</span> <span class="operator">=</span> balanceAvg.getValue();</span><br><span class="line">        System.out.println(<span class="string">&quot;平均薪资：&quot;</span> + value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Account</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> account_number;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> balance;</span><br><span class="line">        <span class="keyword">private</span> String firstname;</span><br><span class="line">        <span class="keyword">private</span> String lastname;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">        <span class="keyword">private</span> String gender;</span><br><span class="line">        <span class="keyword">private</span> String address;</span><br><span class="line">        <span class="keyword">private</span> String employer;</span><br><span class="line">        <span class="keyword">private</span> String email;</span><br><span class="line">        <span class="keyword">private</span> String city;</span><br><span class="line">        <span class="keyword">private</span> String state;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="商城业务"><a href="#商城业务" class="headerlink" title="商城业务"></a>商城业务</h2><h3 id="商品上架"><a href="#商品上架" class="headerlink" title="商品上架"></a>商品上架</h3><p>上架的商品才可以在网站上展示</p>
<p>上架的商品需要可以被检索</p>
<h4 id="sku在es中存储模型分析"><a href="#sku在es中存储模型分析" class="headerlink" title="sku在es中存储模型分析"></a>sku在es中存储模型分析</h4><ol>
<li><h5 id="商城mapping"><a href="#商城mapping" class="headerlink" title="商城mapping"></a>商城mapping</h5></li>
</ol>
<h6 id="分析：商品上架在es中是存sku还是spu-？"><a href="#分析：商品上架在es中是存sku还是spu-？" class="headerlink" title="分析：商品上架在es中是存sku还是spu ？"></a>分析：商品上架在es中是存sku还是spu ？</h6><ol>
<li>检索的时候输入名字，是需要按照sku的title进行全文检索的。</li>
<li>检索使用商品规格，规格是spu的公共属性，每个spu是一样的</li>
<li>按照分类id进去的都是直接列出spu的，还可以切换</li>
<li>我们如果将sku的全量信息保存到es中（包括spu属性）就太多量字段</li>
<li>我们如果将spu以及他包含的sku信息保存到es中，也可以方便检索。但是sku属于spu的级联对象，在es中需要nested模型，这种性能差点。</li>
<li>但是存储与检索我们必须性能折中</li>
<li>如果我们拆分存储，spu和attr一个索引，sku单独一个索引可能涉及的问题</li>
</ol>
<p>检索商品的名字，如“手机”,对应的spu有很多，我们要分析出这些spu的所有关联属性，在做一次查询，就必须将所有spu_id都发出去。假设有1万个数据，数据传输就一次就10000*4&#x3D;4MB；并发情况下假设1000检索请求，那就是4GB的数据，传输阻塞时间会很长，业务无法继续。</p>
<p>所以，我们如下设计，这样才是文档区别于关系型数据库的地方，宽表设计，不能考虑数据库范式。</p>
<p>添加product索引</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;skuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuTitle&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuPrice&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;saleCount&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hasStock&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hotScore&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;attrs&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;attrId&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrName&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot;: false,</span><br><span class="line">            &quot;doc_values&quot;: false</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="nested数据类型场景"><a href="#nested数据类型场景" class="headerlink" title="nested数据类型场景"></a>nested数据类型场景</h4><h5 id="Es-数组的扁平化处理"><a href="#Es-数组的扁平化处理" class="headerlink" title="Es-数组的扁平化处理"></a>Es-数组的扁平化处理</h5><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://center-sept-image.oss-cn-shenzhen.aliyuncs.com/img/image-20201218143304391.png"
                      alt="image-20201218143304391"
                ></p>
<p>为了不让数组扁平化的发生，我们可以使用nested。</p>
<ol>
<li>测试数据</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">PUT my_index/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;group&quot;: &quot;fans&quot;,</span><br><span class="line">  &quot;user&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first&quot;: &quot;John&quot;,</span><br><span class="line">      &quot;last&quot;: &quot;Smith&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;first&quot;: &quot;Alice&quot;,</span><br><span class="line">      &quot;last&quot;: &quot;White&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;user.first&quot;: &quot;Alice&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;user.last&quot;: &quot;Smith&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET my_index/_mapping</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改为嵌入式</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELETE my_index</span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;user&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 再执行上面的插入操作，使用数据进行对比</span><br></pre></td></tr></table></figure>

<h4 id="构造基本数据"><a href="#构造基本数据" class="headerlink" title="构造基本数据"></a>构造基本数据</h4><ol>
<li>添加上架业务</li>
</ol>
<p>SpuInfoController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/&#123;spuId&#125;/up&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">spuUp</span><span class="params">(<span class="meta">@PathVariable(&quot;spuId&quot;)</span> Long spuId)</span>&#123;</span><br><span class="line">    spuInfoService.up(spuId);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpuInfoServiceImpl.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 商品上架</span><br><span class="line"> *</span><br><span class="line"> * @param spuId</span><br><span class="line"> */</span><br><span class="line">@Override</span><br><span class="line">public void up(Long spuId) &#123;</span><br><span class="line">    // 组装需要数据</span><br><span class="line">    // 查出当前spuId对应的所有sku信息,品牌的名称</span><br><span class="line">    List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line">    // todo attrs 查询当前sku的所有可以被用来检索的规格属性</span><br><span class="line">    // 封装每个sku的信息</span><br><span class="line">    skus.stream().map(sku -&gt; &#123;</span><br><span class="line">        SkuEsModel skuEsModel = new SkuEsModel();</span><br><span class="line">        BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">        // skuPrice,skuImg</span><br><span class="line">        skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">        skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">        // hasStock,hotScore</span><br><span class="line">        // todo 1.发送远程调用，库存系统查询是否有库存</span><br><span class="line">        // todo 2.热度评分</span><br><span class="line">        // 3.查询品牌信息</span><br><span class="line">        // brandName,brandImg</span><br><span class="line">        BrandEntity brandEntity = brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">        skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">        skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">        // catalogName</span><br><span class="line">        // 4.查询分类信息</span><br><span class="line">        CategoryEntity categoryEntity = categoryService.getById(skuEsModel.getCatalogId());</span><br><span class="line">        skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line">        return skuEsModel;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    // todo 将数据发送给es进行保存;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Common模块添加 SkuEsModel.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuEsModel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> Long spuId;</span><br><span class="line">    <span class="keyword">private</span> String skuTitle;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal skuPrice;</span><br><span class="line">    <span class="keyword">private</span> String skuImg;</span><br><span class="line">    <span class="keyword">private</span> Long saleCount;</span><br><span class="line">    <span class="keyword">private</span> Boolean hasStock;</span><br><span class="line">    <span class="keyword">private</span> Long hotScore;</span><br><span class="line">    <span class="keyword">private</span> Long brandId;</span><br><span class="line">    <span class="keyword">private</span> Long catalogId;</span><br><span class="line">    <span class="keyword">private</span> String brandName;</span><br><span class="line">    <span class="keyword">private</span> String brandImg;</span><br><span class="line">    <span class="keyword">private</span> String catalogName;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Attrs&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Attrs</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line">        <span class="keyword">private</span> String attrValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SkuInfoServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuInfoEntity&gt; <span class="title function_">getSkusBySpuId</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">    List&lt;SkuInfoEntity&gt; list = <span class="built_in">this</span>.list(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;SkuInfoEntity&gt;().eq(<span class="string">&quot;spu_id&quot;</span>,spuId));</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="构造sku检索数据"><a href="#构造sku检索数据" class="headerlink" title="构造sku检索数据"></a>构造sku检索数据</h4><ol>
<li>查询当前sku的所有可以被用来检索的规格属性</li>
</ol>
<p>1.1 SpuInfoServiceImpl 修改 up 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">up</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">    <span class="comment">// 组装需要数据</span></span><br><span class="line">    <span class="comment">// 查出当前spuId对应的所有sku信息,品牌的名称</span></span><br><span class="line">    List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line">    <span class="comment">//  attrs 查询当前sku的所有可以被用来检索的规格属性</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; baseAttrs = attrValueService.baseAttrlistforspu(spuId);</span><br><span class="line">    List&lt;Long&gt; attrIds = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrs(attrIds);</span><br><span class="line">    Set&lt;Long&gt; idSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(searchAttrIds);</span><br><span class="line">    <span class="comment">// 过滤出不存在的规格属性,构建属性集合</span></span><br><span class="line">    List&lt;SkuEsModel.Attrs&gt; attrs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;SkuEsModel.Attrs&gt; attrsList = baseAttrs.stream().filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> idSet.contains(item.getAttrId());</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        SkuEsModel.<span class="type">Attrs</span> <span class="variable">attrs1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attrs();</span><br><span class="line">        BeanUtils.copyProperties(item, attrs1);</span><br><span class="line">        <span class="keyword">return</span> attrs1;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// 封装每个sku的信息</span></span><br><span class="line">    skus.stream().map(sku -&gt; &#123;</span><br><span class="line">        <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">        BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">        <span class="comment">// skuPrice,skuImg</span></span><br><span class="line">        skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">        skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">        <span class="comment">// hasStock,hotScore</span></span><br><span class="line">        <span class="comment">// todo 1.发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">        <span class="comment">// todo 2.热度评分,暂时定为零</span></span><br><span class="line">        skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line">        <span class="comment">// 3.查询品牌信息</span></span><br><span class="line">        <span class="comment">// brandName,brandImg</span></span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">        skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">        skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">        <span class="comment">// catalogName</span></span><br><span class="line">        <span class="comment">// 4.查询分类信息</span></span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryService.getById(skuEsModel.getCatalogId());</span><br><span class="line">        skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line">        <span class="comment">// 设置检索属性</span></span><br><span class="line">        skuEsModel.setAttrs(attrsList);</span><br><span class="line">        <span class="keyword">return</span> skuEsModel;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// todo 将数据发送给es进行保存;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2 添加根据attrId集合查询检索属性集合</p>
<p>AttrDao.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; selectSearchAttrs(@Param(&quot;attrIds&quot;) List&lt;Long&gt; attrIds);</span><br></pre></td></tr></table></figure>

<p>AttrDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectSearchAttrs&quot;</span>  <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span>&gt;</span></span><br><span class="line">    select attr_id from pms_attr where attr_id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;attrIds&quot;</span> <span class="attr">item</span>=<span class="string">&quot;id&quot;</span> <span class="attr">separator</span>=<span class="string">&quot;,&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span></span><br><span class="line">                #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    and search_type = 1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>AttrService.java </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 在指定的所有属性集合里面，挑出检索属性</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> attrIds</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">List&lt;Long&gt; <span class="title function_">selectSearchAttrs</span><span class="params">(List&lt;Long&gt; attrIds)</span>;</span><br></pre></td></tr></table></figure>

<p>AttrServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Long&gt; <span class="title function_">selectSearchAttrs</span><span class="params">(List&lt;Long&gt; attrIds)</span> &#123;</span><br><span class="line">    List&lt;Long&gt; longs = <span class="built_in">this</span>.baseMapper.selectSearchAttrs(attrIds);</span><br><span class="line">    <span class="keyword">return</span> longs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="远程查询库存-amp-泛型结果封装"><a href="#远程查询库存-amp-泛型结果封装" class="headerlink" title="远程查询库存&amp;泛型结果封装"></a>远程查询库存&amp;泛型结果封装</h4><ol>
<li>远程查询库存</li>
</ol>
<p>1.1 修改上架方法</p>
<p>SpuInfoServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">WareFeignService wareFeignService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">up</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">        <span class="comment">// 组装需要数据</span></span><br><span class="line">        <span class="comment">// 查出当前spuId对应的所有sku信息,品牌的名称</span></span><br><span class="line">        List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line">        List&lt;Long&gt; skuIds = skus.stream().map(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> item.getSkuId();</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">//  attrs 查询当前sku的所有可以被用来检索的规格属性</span></span><br><span class="line">        List&lt;ProductAttrValueEntity&gt; baseAttrs = attrValueService.baseAttrlistforspu(spuId);</span><br><span class="line">        List&lt;Long&gt; attrIds = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrs(attrIds);</span><br><span class="line">        Set&lt;Long&gt; idSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(searchAttrIds);</span><br><span class="line">        <span class="comment">// 过滤出不存在的规格属性,构建属性集合</span></span><br><span class="line">        List&lt;SkuEsModel.Attrs&gt; attrs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        List&lt;SkuEsModel.Attrs&gt; attrsList = baseAttrs.stream().filter(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> idSet.contains(item.getAttrId());</span><br><span class="line">        &#125;).map(item -&gt; &#123;</span><br><span class="line">            SkuEsModel.<span class="type">Attrs</span> <span class="variable">attrs1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attrs();</span><br><span class="line">            BeanUtils.copyProperties(item, attrs1);</span><br><span class="line">            <span class="keyword">return</span> attrs1;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// todo 1.发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">        Map&lt;Long, Boolean&gt; stockMap = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            R&lt;List&lt;SkuHasStockVo&gt;&gt; skusHasStock = wareFeignService.getSkusHasStock(skuIds);</span><br><span class="line">            stockMap = skusHasStock.getData().stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId</span><br><span class="line">                    , item -&gt; item.getHasStock()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;库存服务查询异常：原因&#123;&#125;&quot;</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 封装每个sku的信息</span></span><br><span class="line">        Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">        skus.stream().map(sku -&gt; &#123;</span><br><span class="line">            <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">            BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">            <span class="comment">// skuPrice,skuImg</span></span><br><span class="line">            skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">            skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">            <span class="comment">// hasStock,hotScore</span></span><br><span class="line">            <span class="comment">// 判断是否有库存,然后设置库存信息</span></span><br><span class="line">            <span class="keyword">if</span> (finalStockMap ==<span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果库存服务异常，则默认为有库存 todo</span></span><br><span class="line">                skuEsModel.setHasStock(<span class="literal">true</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                skuEsModel.setHasStock(finalStockMap.get(sku.getSkuId()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// todo 2.热度评分,暂时定为零</span></span><br><span class="line">            skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line">            <span class="comment">// 3.查询品牌信息</span></span><br><span class="line">            <span class="comment">// brandName,brandImg</span></span><br><span class="line">            <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">            skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">            skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">            <span class="comment">// catalogName</span></span><br><span class="line">            <span class="comment">// 4.查询分类信息</span></span><br><span class="line">            <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryService.getById(skuEsModel.getCatalogId());</span><br><span class="line">            skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line">            <span class="comment">// 设置检索属性</span></span><br><span class="line">            skuEsModel.setAttrs(attrsList);</span><br><span class="line">            <span class="keyword">return</span> skuEsModel;</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        <span class="comment">// todo 将数据发送给es进行保存;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>1.2  Ware 模块检索业务</p>
<p>SkuHasStockVo.java Product和Ware模块同时建立这个VO</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SkuHasStockVo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long skuId;</span><br><span class="line">    <span class="keyword">private</span> Boolean hasStock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WareSkuController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/hasstock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> R&lt;List&lt;SkuHasStockVo&gt;&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span> &#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; skuHasStockVos = wareSkuService.getSkusHasStock(skuIds);</span><br><span class="line">    R&lt;List&lt;SkuHasStockVo&gt;&gt; ok = R.ok();</span><br><span class="line">    ok.setData(skuHasStockVos);</span><br><span class="line">    <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WareSkuServiceImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(List&lt;Long&gt; skuIds)</span> &#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; result = skuIds.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">SkuHasStockVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuHasStockVo</span>();</span><br><span class="line">        <span class="comment">// 查询当前sku的总库存量</span></span><br><span class="line">        <span class="comment">// select sum(stock-stock_locked) from `wms_ware_sku` where sku_id = 1</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> baseMapper.getSkuStock(item);</span><br><span class="line">        vo.setSkuId(item);</span><br><span class="line">        vo.setHasStock(count &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WareSkuDao.java</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">long getSkuStock(Long item);</span><br></pre></td></tr></table></figure>

<p>WareSkuDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getSkuStock&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;java.lang.Long&quot;</span> &gt;</span></span><br><span class="line">    select sum(stock-stock_locked) from wms_ware_sku where sku_id = #&#123;skuId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>1.3 Product 模块构建Ware服务的feign</p>
<p>WareFeignService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;supermall-ware&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WareFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.R设计的时候可以加上泛型</span></span><br><span class="line"><span class="comment">     * 2.直接返回对应的类型</span></span><br><span class="line"><span class="comment">     * 3.自己封装解析结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/ware/waresku/hasstock&quot;)</span></span><br><span class="line">    R&lt;List&lt;SkuHasStockVo&gt;&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>泛型结果封装</li>
</ol>
<p>增加R.java 中的泛型成员变量data;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;String, Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(T data)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.data = data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">R</span><span class="params">()</span> &#123;</span><br><span class="line">		put(<span class="string">&quot;code&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> error(HttpStatus.SC_INTERNAL_SERVER_ERROR, <span class="string">&quot;未知异常，请联系管理员&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> error(HttpStatus.SC_INTERNAL_SERVER_ERROR, msg);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">		<span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">		r.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">		r.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">		<span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">		r.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">		<span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">		r.putAll(map);</span><br><span class="line">		<span class="keyword">return</span> r;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> R <span class="title function_">put</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>.put(key, value);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> (Integer) <span class="built_in">this</span>.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> code;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="远程上架接口"><a href="#远程上架接口" class="headerlink" title="远程上架接口"></a>远程上架接口</h4><ol>
<li>在elasticsearch模块新建商品上架信息保存到ES的业务逻辑</li>
</ol>
<p>ElasticSearchSaveController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/search/save&quot;)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticSearchSaveController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ProductSaveService productSaveService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/product&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">productStatusUp</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;SkuEsModel&gt; skuEsModels)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            b = productSaveService.productStatusUp(skuEsModels);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;ElasticSearchSaveController商品上架错误：&#123;&#125;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(), BizCodeEnume.PRODUCT_UP_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 成功</span></span><br><span class="line">        <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">            <span class="keyword">return</span> R.ok();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> R.error(BizCodeEnume.PRODUCT_UP_EXCEPTION.getCode(), BizCodeEnume.PRODUCT_UP_EXCEPTION.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProductSaveService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductSaveService</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">productStatusUp</span><span class="params">(List&lt;SkuEsModel&gt; skuEsModels)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProductSaveServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductSaveServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProductSaveService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">productStatusUp</span><span class="params">(List&lt;SkuEsModel&gt; skuEsModels)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1.给es中建立一个索引。product.</span></span><br><span class="line">        <span class="comment">// 建立好映射关系product-mapping.txt</span></span><br><span class="line">        <span class="comment">// 2.保存到es中</span></span><br><span class="line">        <span class="type">BulkRequest</span> <span class="variable">bulkRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkRequest</span>();</span><br><span class="line">        <span class="keyword">for</span> (SkuEsModel skuEsModel : skuEsModels) &#123;</span><br><span class="line">            <span class="comment">// 赋值索引</span></span><br><span class="line">            <span class="type">IndexRequest</span> <span class="variable">indexRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IndexRequest</span>(EsConstant.PRODUCT_INDEX);</span><br><span class="line">            <span class="comment">// 赋值id</span></span><br><span class="line">            indexRequest.id(skuEsModel.getSkuId().toString());</span><br><span class="line">            <span class="comment">// 设置数据</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> JSON.toJSONString(skuEsModel);</span><br><span class="line">            indexRequest.source(data, XContentType.JSON);</span><br><span class="line">            <span class="comment">// 添加到批量操作中</span></span><br><span class="line">            bulkRequest.add(indexRequest);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BulkResponse</span> <span class="variable">bulk</span> <span class="operator">=</span> restHighLevelClient.bulk(bulkRequest, ElasticSearchConfig.COMMON_OPTIONS);</span><br><span class="line">        <span class="comment">// 处理响应结果</span></span><br><span class="line">        <span class="comment">// todo 如果批量错误</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> bulk.hasFailures();</span><br><span class="line">        List&lt;String&gt; collect = Arrays.stream(bulk.getItems()).map(item -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> item.getId();</span><br><span class="line">        &#125;).collect(Collectors.toList());</span><br><span class="line">        log.error(<span class="string">&quot;商品上架完成：&#123;&#125;&quot;</span>, collect);</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EsConstant 常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EsConstant</span> &#123;</span><br><span class="line">    <span class="comment">// sku数据在ES中的索引</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PRODUCT_INDEX</span> <span class="operator">=</span> <span class="string">&quot;product&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加Product 上架异常错误编码</p>
<p> BizCodeEnume</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">BizCodeEnume</span> &#123;</span><br><span class="line">    UNKNOW_EXCEPTION(<span class="number">10000</span>, <span class="string">&quot;系统未知异常&quot;</span>),</span><br><span class="line">    VAILD_EXCEPTION(<span class="number">10001</span>, <span class="string">&quot;参数格式校验失败&quot;</span>),</span><br><span class="line">    PRODUCT_UP_EXCEPTION(<span class="number">11000</span>, <span class="string">&quot;商品上架异常&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    BizCodeEnume(<span class="type">int</span> code, String msg) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在resource 下新建 product-mapping.txt，保存新建索引内容</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;skuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;spuId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuTitle&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuPrice&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;skuImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;saleCount&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hasStock&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;boolean&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;hotScore&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogId&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;brandImg&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;catalogName&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">        &quot;index&quot;: false,</span><br><span class="line">        &quot;doc_values&quot;: false</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;attrs&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;nested&quot;,</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;attrId&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;long&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrName&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;,</span><br><span class="line">            &quot;index&quot;: false,</span><br><span class="line">            &quot;doc_values&quot;: false</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;attrValue&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>回到product模块，新建远程调用类</li>
</ol>
<p>SearchFeignService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;supermall-elasticsearch&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SearchFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/search/save/product&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> R <span class="title function_">productStatusUp</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;SkuEsModel&gt; skuEsModels)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>修改上架逻辑</li>
</ol>
<p>SpuInfoServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">SearchFeignService searchFeignService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">up</span><span class="params">(Long spuId)</span> &#123;</span><br><span class="line">    <span class="comment">// 组装需要数据</span></span><br><span class="line">    <span class="comment">// 查出当前spuId对应的所有sku信息,品牌的名称</span></span><br><span class="line">    List&lt;SkuInfoEntity&gt; skus = skuInfoService.getSkusBySpuId(spuId);</span><br><span class="line">    List&lt;Long&gt; skuIds = skus.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> item.getSkuId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">//  attrs 查询当前sku的所有可以被用来检索的规格属性</span></span><br><span class="line">    List&lt;ProductAttrValueEntity&gt; baseAttrs = attrValueService.baseAttrlistforspu(spuId);</span><br><span class="line">    List&lt;Long&gt; attrIds = baseAttrs.stream().map(attr -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.getAttrId();</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    List&lt;Long&gt; searchAttrIds = attrService.selectSearchAttrs(attrIds);</span><br><span class="line">    Set&lt;Long&gt; idSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(searchAttrIds);</span><br><span class="line">    <span class="comment">// 过滤出不存在的规格属性,构建属性集合</span></span><br><span class="line">    List&lt;SkuEsModel.Attrs&gt; attrs = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    List&lt;SkuEsModel.Attrs&gt; attrsList = baseAttrs.stream().filter(item -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> idSet.contains(item.getAttrId());</span><br><span class="line">    &#125;).map(item -&gt; &#123;</span><br><span class="line">        SkuEsModel.<span class="type">Attrs</span> <span class="variable">attrs1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>.Attrs();</span><br><span class="line">        BeanUtils.copyProperties(item, attrs1);</span><br><span class="line">        <span class="keyword">return</span> attrs1;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  1.发送远程调用，库存系统查询是否有库存</span></span><br><span class="line">    Map&lt;Long, Boolean&gt; stockMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        R&lt;List&lt;SkuHasStockVo&gt;&gt; skusHasStock = wareFeignService.getSkusHasStock(skuIds);</span><br><span class="line">        stockMap = skusHasStock.getData().stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId</span><br><span class="line">                , item -&gt; item.getHasStock()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;库存服务查询异常：原因&#123;&#125;&quot;</span>,e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 封装每个sku的信息</span></span><br><span class="line">    Map&lt;Long, Boolean&gt; finalStockMap = stockMap;</span><br><span class="line">    List&lt;SkuEsModel&gt; skuEsModels = skus.stream().map(sku -&gt; &#123;</span><br><span class="line">        <span class="type">SkuEsModel</span> <span class="variable">skuEsModel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuEsModel</span>();</span><br><span class="line">        BeanUtils.copyProperties(sku, skuEsModel);</span><br><span class="line">        <span class="comment">// skuPrice,skuImg</span></span><br><span class="line">        skuEsModel.setSkuPrice(sku.getPrice());</span><br><span class="line">        skuEsModel.setSkuImg(sku.getSkuDefaultImg());</span><br><span class="line">        <span class="comment">// hasStock,hotScore</span></span><br><span class="line">        <span class="comment">// 判断是否有库存,然后设置库存信息</span></span><br><span class="line">        <span class="keyword">if</span> (finalStockMap == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果库存服务异常，则默认为有库存 todo</span></span><br><span class="line">            skuEsModel.setHasStock(<span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            skuEsModel.setHasStock(finalStockMap.get(sku.getSkuId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// todo 2.热度评分,暂时定为零</span></span><br><span class="line">        skuEsModel.setHotScore(<span class="number">0L</span>);</span><br><span class="line">        <span class="comment">// 3.查询品牌信息</span></span><br><span class="line">        <span class="comment">// brandName,brandImg</span></span><br><span class="line">        <span class="type">BrandEntity</span> <span class="variable">brandEntity</span> <span class="operator">=</span> brandService.getById(skuEsModel.getBrandId());</span><br><span class="line">        skuEsModel.setBrandName(brandEntity.getName());</span><br><span class="line">        skuEsModel.setBrandImg(brandEntity.getLogo());</span><br><span class="line">        <span class="comment">// catalogName</span></span><br><span class="line">        <span class="comment">// 4.查询分类信息</span></span><br><span class="line">        <span class="type">CategoryEntity</span> <span class="variable">categoryEntity</span> <span class="operator">=</span> categoryService.getById(skuEsModel.getCatalogId());</span><br><span class="line">        skuEsModel.setCatalogName(categoryEntity.getName());</span><br><span class="line">        <span class="comment">// 设置检索属性</span></span><br><span class="line">        skuEsModel.setAttrs(attrsList);</span><br><span class="line">        <span class="keyword">return</span> skuEsModel;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="comment">// todo 将数据发送给es进行保存;</span></span><br><span class="line">    <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> searchFeignService.productStatusUp(skuEsModels);</span><br><span class="line">    <span class="keyword">if</span> (r.getCode()==<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 远程调用成功</span></span><br><span class="line">        <span class="comment">// 修改当前Spu的上架状态</span></span><br><span class="line">        baseMapper.updateSpuStatus(spuId, ProductConstant.StatusEnum.SPU_UP.getCode());</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 调用失败</span></span><br><span class="line">        <span class="comment">// todo 重复调用，接口的幂等</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpuInfoDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">updateSpuStatus</span><span class="params">(<span class="meta">@Param(&quot;spuId&quot;)</span> Long spuId, <span class="meta">@Param(&quot;code&quot;)</span> <span class="type">int</span> code)</span>;</span><br></pre></td></tr></table></figure>

<p>SpuInfoDao.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateSpuStatus&quot;</span>&gt;</span></span><br><span class="line">    UPDATE pms_spu_info set public_status=#&#123;code&#125;,update_time = NOW() where id = #&#123;spuId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="上架接口调试-amp-feign源码"><a href="#上架接口调试-amp-feign源码" class="headerlink" title="上架接口调试&amp;feign源码"></a>上架接口调试&amp;feign源码</h4><ol>
<li>WareSkuServiceImpl 修改 getSkusHasStock 方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(List&lt;Long&gt; skuIds)</span> &#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; result = skuIds.stream().map(item -&gt; &#123;</span><br><span class="line">        <span class="type">SkuHasStockVo</span> <span class="variable">vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SkuHasStockVo</span>();</span><br><span class="line">        <span class="comment">// 查询当前sku的总库存量</span></span><br><span class="line">        <span class="comment">// select sum(stock-stock_locked) from `wms_ware_sku` where sku_id = 1</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">count</span> <span class="operator">=</span> baseMapper.getSkuStock(item);</span><br><span class="line">        vo.setSkuId(item);</span><br><span class="line">        vo.setHasStock(count == <span class="literal">null</span> ? <span class="literal">false</span> : count &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> vo;</span><br><span class="line">    &#125;).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WareSkuDao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Long <span class="title function_">getSkuStock</span><span class="params">(Long item)</span>;</span><br></pre></td></tr></table></figure>

<p>WareFeignService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(&quot;supermall-ware&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">WareFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.R设计的时候可以加上泛型</span></span><br><span class="line"><span class="comment">     * 2.直接返回对应的类型</span></span><br><span class="line"><span class="comment">     * 3.自己封装解析结果</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> skuIds</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/ware/waresku/hasstock&quot;)</span></span><br><span class="line">    List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WareSkuController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/hasstock&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;SkuHasStockVo&gt; <span class="title function_">getSkusHasStock</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;Long&gt; skuIds)</span> &#123;</span><br><span class="line">    List&lt;SkuHasStockVo&gt; skuHasStockVos = wareSkuService.getSkusHasStock(skuIds);</span><br><span class="line">    <span class="keyword">return</span> skuHasStockVos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="抽取响应结果-amp-上架测试完成"><a href="#抽取响应结果-amp-上架测试完成" class="headerlink" title="抽取响应结果&amp;上架测试完成"></a>抽取响应结果&amp;上架测试完成</h4><ol>
<li>R继承了hashMap 在里面定义泛型成员变量，没有效果？</li>
</ol>
<p>R.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">R</span> <span class="keyword">extends</span> <span class="title class_">HashMap</span>&lt;String, Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">setData</span><span class="params">(Object data)</span> &#123;</span><br><span class="line">      put(<span class="string">&quot;data&quot;</span>, data);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getData</span><span class="params">(TypeReference&lt;T&gt; tTypeReference)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.getData(<span class="string">&quot;data&quot;</span>, tTypeReference);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getData</span><span class="params">(String key, TypeReference&lt;T&gt; tTypeReference)</span> &#123;</span><br><span class="line">      <span class="type">Object</span> <span class="variable">data</span> <span class="operator">=</span> <span class="built_in">this</span>.get(key);</span><br><span class="line">      <span class="type">String</span> <span class="variable">toJSONString</span> <span class="operator">=</span> JSON.toJSONString(data);</span><br><span class="line">      <span class="type">T</span> <span class="variable">t</span> <span class="operator">=</span> JSON.parseObject(toJSONString, tTypeReference);</span><br><span class="line">      <span class="keyword">return</span> t;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">R</span><span class="params">()</span> &#123;</span><br><span class="line">      put(<span class="string">&quot;code&quot;</span>, <span class="number">0</span>);</span><br><span class="line">      put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> error(HttpStatus.SC_INTERNAL_SERVER_ERROR, <span class="string">&quot;未知异常，请联系管理员&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> error(HttpStatus.SC_INTERNAL_SERVER_ERROR, msg);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">error</span><span class="params">(<span class="type">int</span> code, String msg)</span> &#123;</span><br><span class="line">      <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">      r.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">      r.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">      <span class="keyword">return</span> r;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">      <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">      r.put(<span class="string">&quot;msg&quot;</span>, msg);</span><br><span class="line">      <span class="keyword">return</span> r;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">(Map&lt;String, Object&gt; map)</span> &#123;</span><br><span class="line">      <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">      r.putAll(map);</span><br><span class="line">      <span class="keyword">return</span> r;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> R <span class="title function_">ok</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">R</span>();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> R <span class="title function_">put</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.put(key, value);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Integer <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">Integer</span> <span class="variable">code</span> <span class="operator">=</span> (Integer) <span class="built_in">this</span>.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> code;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用alibaba.json 快速转换，SpuInfoServiceImpl中的up</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeReference&lt;List&lt;SkuHasStockVo&gt;&gt; typeReference = <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;List&lt;SkuHasStockVo&gt;&gt;()&#123;&#125;;       skuHasStocks.getData(typeReference).stream().collect(Collectors.toMap(SkuHasStockVo::getSkuId, SkuHasStockVo::getHasStock));</span><br></pre></td></tr></table></figure>



<h3 id="首页"><a href="#首页" class="headerlink" title="首页"></a>首页</h3><h4 id="整合thymeleaf渲染首页"><a href="#整合thymeleaf渲染首页" class="headerlink" title="整合thymeleaf渲染首页"></a>整合thymeleaf渲染首页</h4><p>动静分离架构，网关更好的做鉴权</p>
<p>动静分离：</p>
<p>静：图片，js，css等静态资源（以实际文件存在的方式）</p>
<p>动：服务器需要处理的请求</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://center-sept-image.oss-cn-shenzhen.aliyuncs.com/img/image-20201222150442692.png"
                      alt="image-20201222150442692"
                ></p>
<ol>
<li>在Product导入thymeleaf 模板引擎</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   thymeleaf 依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>导入商城静态资源到resouce&#x2F;static下，页面拷贝到template文件夹下；要看默认配置，查看WebMvcAutoConfiguration.java类。</li>
<li>在配置文件加入以下配置，暂时不是用缓存，让页面实时更新。</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">thymeleaf:</span></span><br><span class="line">    <span class="attr">cache:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>创建一个web包，要来处理页面请求</li>
</ol>
<h4 id="整合dev-tools渲染一级分类数据"><a href="#整合dev-tools渲染一级分类数据" class="headerlink" title="整合dev-tools渲染一级分类数据"></a>整合dev-tools渲染一级分类数据</h4><ol>
<li>创建首页请求相应类IndexController</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IndexController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&#123;&quot;/&quot;, &quot;index.html&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">indexPage</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        <span class="comment">//获取一级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; list = categoryService.getLevelFirstCategorys();</span><br><span class="line">        model.addAttribute(<span class="string">&quot;categorys&quot;</span>, list);</span><br><span class="line">        <span class="comment">// 视图解析器自动拼接前后缀</span></span><br><span class="line">        <span class="comment">// classpath:templates/   + index + .html</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>新建查询一级分类方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevelFirstCategorys</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; list = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>声明 thymeleaf 语法到html中</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用thymeleaf语法渲染一级分类</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;header_main_left&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">th:each</span>=<span class="string">&quot; category : $&#123;categorys&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;header_main_left_a&quot;</span>  <span class="attr">th:attr</span>=<span class="string">&quot;ctg-data=$&#123;category.catId&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;category.name&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>修改页面，无需重启服务器实时更新页面</li>
</ol>
<p>5.1 需要引入dev-tool 依赖，product pom 中加入以下依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   dev-tool--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--   true 为开启 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>5.2 页面修改完，build项目，就相当于发布完成。</p>
<h4 id="渲染二级和三级分类数据"><a href="#渲染二级和三级分类数据" class="headerlink" title="渲染二级和三级分类数据"></a>渲染二级和三级分类数据</h4><ol>
<li>由于菜单渲染是根据catalogLoader.js这个文件请求 index&#x2F;json&#x2F;catalog.json来获取resouce下的静态文件catalog.json中的数据的。所以我们需要读取数据库中配置的动态数据作为渲染数据。</li>
<li>在后端做二三级渲染</li>
</ol>
<p>Catelog2Vo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Catelog2Vo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String catalog1Id;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; catalog3List;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Catelog3Vo</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String catalog2Id;</span><br><span class="line">        <span class="keyword">private</span> String id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CategoryServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 查出所有一级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; levelFirstCategorys = getLevelFirstCategorys();</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; collect = levelFirstCategorys.stream().collect(Collectors.toMap(k -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> k.getCatId().toString();</span><br><span class="line">    &#125;, lv1 -&gt; &#123;</span><br><span class="line">        <span class="comment">// 每一个的一级分类，查到这个一级分类的二级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; list2 = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>,</span><br><span class="line">                lv1.getCatId()));</span><br><span class="line">        List&lt;Catelog2Vo&gt; collect2 = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (list2 != <span class="literal">null</span>) &#123;</span><br><span class="line">            collect2 = list2.stream().map(lv2 -&gt; &#123;</span><br><span class="line">                <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(lv1.getCatId().toString(), <span class="literal">null</span>, lv2.getCatId().toString()</span><br><span class="line">                        , lv2.getName());</span><br><span class="line">                List&lt;CategoryEntity&gt; list3 = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(</span><br><span class="line">                        <span class="string">&quot;parent_cid&quot;</span>,</span><br><span class="line">                        lv2.getCatId()));</span><br><span class="line">                <span class="keyword">if</span> (list3 != <span class="literal">null</span>) &#123;</span><br><span class="line">                    List&lt;Catelog2Vo.Catelog3Vo&gt; collect3 = list3.stream().map(lv3 -&gt; &#123;</span><br><span class="line">                        Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(lv2.getCatId().toString(),</span><br><span class="line">                                lv3.getCatId().toString(), lv3.getName());</span><br><span class="line">                        <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line">                    catelog2Vo.setCatalog3List(collect3);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> collect2;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IndexController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/index/catalog.json&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; result = categoryService.getCatalogJson();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改catalogLoader.js 请求路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(&quot;index/catalog.json&quot;,function (data) </span><br></pre></td></tr></table></figure>



<h3 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h3><h4 id="搭建域名访问环境一（反向代理配置）"><a href="#搭建域名访问环境一（反向代理配置）" class="headerlink" title="搭建域名访问环境一（反向代理配置）"></a>搭建域名访问环境一（反向代理配置）</h4><h5 id="正向代理与反向代理"><a href="#正向代理与反向代理" class="headerlink" title="正向代理与反向代理"></a>正向代理与反向代理</h5><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="https://center-sept-image.oss-cn-shenzhen.aliyuncs.com/img/image-20201223095121108.png"
                      alt="image-20201223095121108"
                ></p>
<ol>
<li>使用SwitchHosts直接可以修改hosts配置文件，并提供添加修改方法策略。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.72.130 supermall.com</span><br></pre></td></tr></table></figure>

<ol>
<li>启动虚拟机nginx</li>
</ol>
<p>2.1 在挂载的conf.d文件夹下创建一个配置conf，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#http服务，一个server可以配置多个location</span><br><span class="line">server &#123; </span><br><span class="line">        listen       80; #服务监听端口</span><br><span class="line">        server_name  supermall.com; #主机名、域名</span><br><span class="line">    </span><br><span class="line">        #charset koi8-r;</span><br><span class="line">        #access_log  /var/log/nginx/host.access.log  main;</span><br><span class="line">    </span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://&#123;这里为你的主机的网关地址加Product模块端口号&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        #error_page  404              /404.html;</span><br><span class="line">    </span><br><span class="line">        # 将500 502 503 504的错误页面重定向到 /50x.html</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123; #匹配error_page指定的页面路径</span><br><span class="line">            root   /usr/share/nginx/html; #页面存放的目录</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    proxy_pass   http://127.0.0.1;</span><br><span class="line">        #&#125;</span><br><span class="line">    </span><br><span class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</span><br><span class="line">        #</span><br><span class="line">        #location ~ \.php$ &#123;</span><br><span class="line">        #    root           html;</span><br><span class="line">        #    fastcgi_pass   127.0.0.1:9000;</span><br><span class="line">        #    fastcgi_index  index.php;</span><br><span class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</span><br><span class="line">        #    include        fastcgi_params;</span><br><span class="line">        #&#125;</span><br><span class="line">    </span><br><span class="line">        # deny access to .htaccess files, if Apache&#x27;s document root</span><br><span class="line">        # concurs with nginx&#x27;s one</span><br><span class="line">        #</span><br><span class="line">        #location ~ /\.ht &#123;</span><br><span class="line">        #    deny  all;</span><br><span class="line">        #&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2.2 在你的主机启动项目，访问在hosts中配置好的映射域名进行访问，我的是supermall.com</p>
<h4 id="搭建域名访问环境二（负载均衡到网关）"><a href="#搭建域名访问环境二（负载均衡到网关）" class="headerlink" title="搭建域名访问环境二（负载均衡到网关）"></a>搭建域名访问环境二（负载均衡到网关）</h4><ol>
<li>新增负载均衡 upstream</li>
</ol>
<p>1.1 在nginx.conf 中加入以下负载均衡配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upstream supermall &#123;</span><br><span class="line">	server 192.168.72.1:88;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1.2 在supermall.conf 中替换内容：</p>
<p>注：因为nginx会对请求做丢弃处理，所以为了让请求头中host属性不会被丢弃而造成请求达到网关服务时候匹配不到服务，所以我们需要加上proxy_set header Host $host</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    proxy_set header Host $host;</span><br><span class="line">    proxy_pass http://supermall;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置网关服务，加入页面请求断言</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">super_mall_host_route</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://supermall-product</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Host=**.supermall.com,supermall.com</span></span><br></pre></td></tr></table></figure>



<h2 id="性能压测"><a href="#性能压测" class="headerlink" title="性能压测"></a>性能压测</h2><h3 id="压力测试"><a href="#压力测试" class="headerlink" title="压力测试"></a>压力测试</h3><h4 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h4><p>压力测试考察当前软硬件环境下系统所能承受的最大负荷并帮助找出系统瓶颈所在。压测都是为了系统在线上的处理能力和稳定性维持在一个标准范围内，做到心中有数。</p>
<p>使用压力测试，我们有希望找到很多种用其他测试方法更难发现的错误。有两种错误类型是：</p>
<p><strong>内存泄漏，并发与同步</strong></p>
<p>有效的压力测试系统将应用以下这些关键条件：<strong>重复，并发，量级，随机变化。</strong></p>
<ol>
<li><h5 id="性能指标"><a href="#性能指标" class="headerlink" title="性能指标"></a>性能指标</h5></li>
</ol>
<p>响应时间（Response Time:RT）</p>
<p>​	响应时间指用户从客户端发起一个请求开始，到客户端接收到从服务器端返回的响应结束，整个过程所耗费的时间。</p>
<p>HPS（Hits Per Second）</p>
<p>​	每秒点击次数，单位是次&#x2F;秒</p>
<p>TPS（Transaction per Second）</p>
<p>​	系统每秒处理交易数，单位是笔&#x2F;秒</p>
<p>QPS（Query per Second）</p>
<p>​	系统每秒处理查询次数，单位是次&#x2F;秒</p>
<p>​	对于互联网业务中，如果某些业务有且仅有一个请求连接，那么TPS&#x3D;QPS&#x3D;HPS，一般情况下用TPS来衡量整个业务流程，用QPS来衡量接口查询次数，用HPS来表示对服务器单词请求次数。</p>
<p>无论是TPS，QPS，HPS，此指标是衡量系统处理能力非常重要的指标，越大越好，根据经验，一般情况：</p>
<p>​	金融行业：1000TPS~50000TPS，不包括互联网化的活动</p>
<p>​	保险行业：100TPS~100000TPS，不包括互联网化的活动</p>
<p>​	制造行业：10TPS~5000TPS</p>
<p>​	互联网电子商务：10000TPS~1000000TPS</p>
<p>​	互联网中型网站：1000TPS~50000TPS</p>
<p>​	互联网小型网站：500TPS~10000TPS</p>
<p>最大响应时间（Max Response Time）：指用户发出请求或者指令到系统做出反应（响应）的最大时间。</p>
<p>最少响应时间（Mininum Response Time）：指用户发出请求或者指令到系统做出反应（响应）的最少时间。</p>
<p>90%响应时间（90% Response Time）：是指所有用户的响应时间进行排序，第90%的响应时间。</p>
<p>从外部看，性能测试主要关注如下三个指标：</p>
<p>​	吞吐量：每秒钟系统能够处理的请求数，任务数。</p>
<p>​	响应时间：服务处理一个请求或一个任务的耗时。</p>
<p>​	错误率：一批请求中结果出错的请求所占比例。</p>
<h4 id="Apache-JMeter安装使用"><a href="#Apache-JMeter安装使用" class="headerlink" title="Apache JMeter安装使用"></a>Apache JMeter安装使用</h4><ol>
<li>JMeter 安装</li>
</ol>
<p><a class="link"   target="_blank" rel="noopener" href="https://jmeter.apache.org/download_jmeter.cgi" >https://jmeter.apache.org/download_jmeter.cgi<i class="fas fa-external-link-alt"></i></a></p>
<p>下载对应的压缩包，解压运行jmeter.bat 即可</p>
<ol start="2">
<li><p>JMeter的使用（多用用）</p>
</li>
<li><p>压测调优</p>
</li>
</ol>
<p>3.1 加大JVM内存</p>
<p>3.2 加大tomcat的最大线程数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.tomcat.max-threads=200</span><br></pre></td></tr></table></figure>

<h4 id="JMeter在windows下地址占用bug解决"><a href="#JMeter在windows下地址占用bug解决" class="headerlink" title="JMeter在windows下地址占用bug解决"></a>JMeter在windows下地址占用bug解决</h4><h5 id="JMeter-Address-Already-in-user-错误解决"><a href="#JMeter-Address-Already-in-user-错误解决" class="headerlink" title="JMeter Address Already in user 错误解决"></a>JMeter Address Already in user 错误解决</h5><p>windows本身提供的端口访问机制的问题。</p>
<p>Windows 提供给TCP&#x2F;IP链接的端口为1024-5000，并且要四分钟来循环回收他们。就导致我们在短时间内跑大量的请求时将端口占满了。</p>
<p>解决方案：</p>
<ol>
<li>cmd中，用regedit命令打开注册表</li>
<li>在HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Service\Tcpip\Parameters 下，<ol>
<li>右击parameters，添加一个新的DWORD，名字为MaxUserPort</li>
<li>然后点击MaxUserPort，输入数值数据为65534，基数选择十进制（如果是分布式运行的话，控制机器和负载机器都需要这样操作）</li>
</ol>
</li>
<li>修改配置完毕后重启机器</li>
<li>按照以上步骤再入TCPTimedWaitDelay：30</li>
</ol>
<h3 id="性能监控"><a href="#性能监控" class="headerlink" title="性能监控"></a>性能监控</h3><h4 id="堆内存与垃圾回收"><a href="#堆内存与垃圾回收" class="headerlink" title="堆内存与垃圾回收"></a>堆内存与垃圾回收</h4><p>影响性能考虑点包括：</p>
<p>​	数据库，应用程序，中间件（tomcat，nginx）,网络和操作系统等方面</p>
<p>首先考虑自己的应用属于 <strong>CPU密集型</strong> 还是 <strong>IO密集型</strong></p>
<h4 id="jconsole与jvisualvm"><a href="#jconsole与jvisualvm" class="headerlink" title="jconsole与jvisualvm"></a>jconsole与jvisualvm</h4><p>​	Jdk的两个小工具jconsole，jvisualvm（升级版jconsole）;通过命令行启动，可监控本地和远程应用。远程应用需要配置。</p>
<p>在windows下 cmd 下，执行命令 jconsole 或者 jvisualvm 就可以打开。</p>
<h5 id="jvisualvm能干什么？"><a href="#jvisualvm能干什么？" class="headerlink" title="jvisualvm能干什么？"></a>jvisualvm能干什么？</h5><p>监控内存泄露，跟踪垃圾回收，执行时内存，cpu分析，线程分析</p>
<p>运行：正在运行</p>
<p>休眠：sleep</p>
<p>等待：wait</p>
<p>驻留：线程池里面的空闲线程</p>
<p>监视：阻塞的线程，正在等待锁</p>
<h5 id="安装插件方便查看GC"><a href="#安装插件方便查看GC" class="headerlink" title="安装插件方便查看GC"></a>安装插件方便查看GC</h5><ol>
<li>启动jvisualvm，工具-&gt;插件</li>
<li>如果503错误解决：</li>
</ol>
<p>2.1 打开网址<a class="link"   target="_blank" rel="noopener" href="https://visualvm.github.io/pluginscenters.html" >https://visualvm.github.io/pluginscenters.html<i class="fas fa-external-link-alt"></i></a></p>
<p>2.2 cmd 查看自己的的jdk版本，找到对应的版本，然后复制网页上的Catalog URL</p>
<p>2.3 然后粘贴到更新插件中心的URL中，最后可以使用插件中心了，下载Vusual GC 插件可以查看动态的GC。</p>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><h4 id="中间件对性能的影响"><a href="#中间件对性能的影响" class="headerlink" title="中间件对性能的影响"></a>中间件对性能的影响</h4><ol>
<li><p>使用JMeter，50线程不断请求nginx，然后使用docker stats 命令查看nginx容器的状态。</p>
</li>
<li><p>压测网关，使用JvisualVM查看cpu和GC状态</p>
</li>
<li><p>使用一个普通的业务模块压测，使用JvisualVM查看cpu和GC状态。</p>
</li>
<li><p>网关加简单业务服务，使用JvisualVM查看cpu和GC状态。</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>压测内容</th>
<th>压测线程数</th>
<th>吞吐量&#x2F;s</th>
<th>90%响应时间</th>
<th>99%响应时间</th>
</tr>
</thead>
<tbody><tr>
<td>Nginx</td>
<td>50</td>
<td>5152</td>
<td>11</td>
<td>16</td>
</tr>
<tr>
<td>Gateway</td>
<td>50</td>
<td>4986</td>
<td>1</td>
<td>4</td>
</tr>
<tr>
<td>简单服务</td>
<td>50</td>
<td>5247</td>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>首页一级菜单渲染（thymeleaf缓存）</td>
<td>50</td>
<td>290</td>
<td></td>
<td></td>
</tr>
<tr>
<td>首页一级菜单渲染</td>
<td>50</td>
<td>515</td>
<td>51</td>
<td>79</td>
</tr>
<tr>
<td>首页一级菜单渲染（thymeleaf缓存+db索引+取消日志）</td>
<td>50</td>
<td>270</td>
<td>267</td>
<td>365</td>
</tr>
<tr>
<td>三级分类数据获取</td>
<td>50</td>
<td>15</td>
<td>3690</td>
<td>4007</td>
</tr>
<tr>
<td>首页全量数据获取</td>
<td>50</td>
<td>7 (静态资源)</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Nginx+Gateway</td>
<td>50</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gateway+简单服务</td>
<td>50</td>
<td>2675</td>
<td>5</td>
<td>12</td>
</tr>
<tr>
<td>全链路</td>
<td>50</td>
<td>1225</td>
<td>34</td>
<td>45</td>
</tr>
</tbody></table>
<p><strong>结论：中间件越多，性能损耗越大，大多都损失在网络交互。</strong></p>
<p>优化：</p>
<p>SQL耗时越小越好，一般情况下微秒级别。</p>
<p>命中率越高越好，一般情况下不能低于95%</p>
<p>锁等待次数越低越好，等待时间越短越好。</p>
<h4 id="简单优化吞吐量测试"><a href="#简单优化吞吐量测试" class="headerlink" title="简单优化吞吐量测试"></a>简单优化吞吐量测试</h4><ol>
<li><p>压测首页一级菜单</p>
</li>
<li><p>直接压测三级菜单</p>
</li>
<li><p>压测首页全量数据（图片，js等静态数据）</p>
</li>
</ol>
<p>JMeter http取样器中选择高级，勾选”从HTML文件中获取所有的资源”</p>
<ol start="4">
<li>首页一级菜单渲染（thymeleaf缓存+db索引+取消日志）</li>
<li>首页一级菜单渲染（thymeleaf缓存）</li>
<li>优化之后的全量数据</li>
</ol>
<h4 id="nginx动静分离"><a href="#nginx动静分离" class="headerlink" title="nginx动静分离"></a>nginx动静分离</h4><ol>
<li>将所有项目的静态资源都nginx里面</li>
<li>指定一个规则：&#x2F;static&#x2F;***下的所有请求都有nginx直接返回</li>
<li>在nginx的html下创建static文件夹专门存放静态资源</li>
<li>然后修改index.html中的所有静态资源路径，在路径前加上static或&#x2F;static</li>
</ol>
<p>href&#x3D;” 替换href&#x3D;”&#x2F;static&#x2F;</p>
<script src=" 替换 <script src="/static/

<img  src=" 替换 <img 
                     lazyload
                     src="/images/loading.svg"
                     data-src="/static/

5. nginx的商城配置文件加入以下配置：

<figure class="
                     highlight plaintext"
                ><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> location /static/ &#123;</span><br><span class="line">     root /usr/share/nginx/html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

6. JS 文件的路径也要重新配置

#### 模拟线上应用内存崩溃宕机情况

GC时间的占用是硬指标

JVM调优，合理分配内容

#### 优化三级分类数据获取

1. 将数据库的多次查询变为一次

   

## 缓存

### 缓存使用

#### 本地缓存与分布式缓存

​	为了系统性能的提升，我们一般都会将部分数据放入缓存中，加速访问。而db承担数据落盘工作。

哪些数据适合放入缓存？

1. 即时性、数据一致性要求不高的。
2. 访问量大且更新频率不高的数据（读多，写少）

#### 整合redis测试

1. 引入redis的启动器

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   整合 redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

2. 加入redis的配置信息

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    host: 192.168.72.130</span><br><span class="line">    port: 6379</span><br></pre></td></tr></table></figure>

3. 引入配置bean

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Autowired</span><br><span class="line">StringRedisTemplate stringRedisTemplate;</span><br></pre></td></tr></table></figure>

4. 测试bean是否引入

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Autowired</span></span><br><span class="line"> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testStringRedisTemplate</span><span class="params">()</span> &#123;</span><br><span class="line">     ValueOperations&lt;String, String&gt; stringStringValueOperations =</span><br><span class="line">             stringRedisTemplate.opsForValue();</span><br><span class="line">     stringStringValueOperations.set(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span> + UUID.randomUUID().toString());</span><br><span class="line">     <span class="type">String</span> <span class="variable">hello</span> <span class="operator">=</span> stringStringValueOperations.get(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">     System.out.println(<span class="string">&quot;保存的数据是：&quot;</span> + hello);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



#### 改造三级分类业务

1. 修改CategoryServiceImpl类中getCatalogJson方法

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 加入缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;catalogJSON&quot;</span>);</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">        <span class="comment">// 缓存中没有</span></span><br><span class="line">        <span class="comment">// 从数据库中取数据</span></span><br><span class="line">        catalogJson = getCatalogJsonFromDb();</span><br><span class="line">        <span class="comment">// 查到的数据转为json对象放到缓存中</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;catalogJSON&quot;</span>, JSON.toJSONString(catalogJson));</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br><span class="line">    catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> catalogJson;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromDb</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 一次将所有数据查出来</span></span><br><span class="line">    List&lt;CategoryEntity&gt; all = baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 查出所有一级分类</span></span><br><span class="line">    List&lt;CategoryEntity&gt; levelFirstCategorys = getItem(all, <span class="number">0L</span>);</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; collect = levelFirstCategorys.stream().collect(Collectors.toMap(k -&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> k.getCatId().toString();</span><br><span class="line">    &#125;, lv1 -&gt; &#123;</span><br><span class="line">        <span class="comment">// 每一个的一级分类，查到这个一级分类的二级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; list2 = getItem(all, lv1.getParentCid());</span><br><span class="line">        List&lt;Catelog2Vo&gt; collect2 = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (list2 != <span class="literal">null</span>) &#123;</span><br><span class="line">            collect2 = list2.stream().map(lv2 -&gt; &#123;</span><br><span class="line">                <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(lv1.getCatId().toString(), <span class="literal">null</span>, lv2.getCatId().toString()</span><br><span class="line">                        , lv2.getName());</span><br><span class="line">                List&lt;CategoryEntity&gt; list3 = getItem(all, lv2.getParentCid());</span><br><span class="line">                <span class="keyword">if</span> (list3 != <span class="literal">null</span>) &#123;</span><br><span class="line">                    List&lt;Catelog2Vo.Catelog3Vo&gt; collect3 = list3.stream().map(lv3 -&gt; &#123;</span><br><span class="line">                        Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(lv2.getCatId().toString(),</span><br><span class="line">                                lv3.getCatId().toString(), lv3.getName());</span><br><span class="line">                        <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                    &#125;).collect(Collectors.toList());</span><br><span class="line">                    catelog2Vo.setCatalog3List(collect3);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> collect2;</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> collect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



#### 压力测试出的内存泄露及解决

使用原本redis 启动器自带的lettuce redis 客户端连接器会造成什么问题?

会产生对外内存溢出：OutOfDirectMemoryError

原因：lettuce的bug导致netty堆外内存溢出 -Xmx300m；netty如果没有指定堆外内存，默认使用-Xmx300m 

解决方案：

1. 可以使用-Dio.netty.maxDirectMemory调大这个最大内存（但是解决不了根本性问题）
2. 升级lettuce客户端版本
3. 切换使用jedis

3.1 去除使用lettuce依赖，加上jedis依赖

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--   整合 redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

redisTemplate 与 lettuce 、jedis 的关系？

lettuce、jedis都是操作redis的底层客户端。Spring 在 RedisAutoConfiguration 中对这两个客户端进行再次封装，生成一个工厂连接类。

#### 缓存击穿、穿透、雪崩

穿透：直接返回null值

雪崩：随机设置过期时间

击穿：只有一个线程进行查库操作，获取锁在进行操作



#### 加锁解决缓存击穿问题

改造获取三级分类方法

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 加入缓存</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;catalogJSON&quot;</span>);</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">        <span class="comment">// 缓存中没有</span></span><br><span class="line">        <span class="comment">// 从数据库中取数据</span></span><br><span class="line">        catalogJson = getCatalogJsonFromDb();</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br><span class="line">    catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> catalogJson;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromDb</span><span class="params">()</span> &#123;</span><br><span class="line">    Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">    <span class="comment">// 本地进程保证只有一个线程进入查询数据库</span></span><br><span class="line">    <span class="comment">// TODO 分布式接口需要替换成分布式锁</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 进入到查询原子操作,再次执行缓存查询</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;catalogJSON&quot;</span>);</span><br><span class="line">        <span class="comment">// 不为空直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">            catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> catalogJson;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;缓存中不存在三级菜单数据,需要调用db查询&quot;</span>);</span><br><span class="line">        <span class="comment">// 一次将所有数据查出来</span></span><br><span class="line">        List&lt;CategoryEntity&gt; all = baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 查出所有一级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; levelFirstCategorys = getItem(all, <span class="number">0L</span>);</span><br><span class="line">        catalogJson = levelFirstCategorys.stream().collect(Collectors.toMap(k -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> k.getCatId().toString();</span><br><span class="line">        &#125;, lv1 -&gt; &#123;</span><br><span class="line">            <span class="comment">// 每一个的一级分类，查到这个一级分类的二级分类</span></span><br><span class="line">            List&lt;CategoryEntity&gt; list2 = getItem(all, lv1.getParentCid());</span><br><span class="line">            List&lt;Catelog2Vo&gt; collect2 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (list2 != <span class="literal">null</span>) &#123;</span><br><span class="line">                collect2 = list2.stream().map(lv2 -&gt; &#123;</span><br><span class="line">                    <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(lv1.getCatId().toString(), <span class="literal">null</span>,</span><br><span class="line">                            lv2.getCatId().toString()</span><br><span class="line">                            , lv2.getName());</span><br><span class="line">                    List&lt;CategoryEntity&gt; list3 = getItem(all, lv2.getParentCid());</span><br><span class="line">                    <span class="keyword">if</span> (list3 != <span class="literal">null</span>) &#123;</span><br><span class="line">                        List&lt;Catelog2Vo.Catelog3Vo&gt; collect3 = list3.stream().map(lv3 -&gt; &#123;</span><br><span class="line">                            Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(lv2.getCatId().toString(),</span><br><span class="line">                                    lv3.getCatId().toString(), lv3.getName());</span><br><span class="line">                            <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                        &#125;).collect(Collectors.toList());</span><br><span class="line">                        catelog2Vo.setCatalog3List(collect3);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> collect2;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="comment">// 查库,将结果同步至缓存,必须是一个原子操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;将db返回的结果同步到缓存中...&quot;</span>);</span><br><span class="line">        <span class="comment">// 查到的数据转为json对象放到缓存中</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;catalogJSON&quot;</span>, JSON.toJSONString(catalogJson), <span class="number">1</span>, TimeUnit.DAYS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> catalogJson;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

##### 锁的时序问题

保证查询db操作和更新缓存操作的原子性

1. 再次确认缓存中不存在数据
2. 查询数库
3. 将结果放入缓存



#### 本地锁在分布式下的问题

将Product 服务复制多份，分别使用不同的端口启动，然后使用网关地址进行压测

--server.port={指定不冲突的端口号}





## 分布式锁

#### 分布式锁原理与使用

1. 使用redis 提供的nx参数，判断该key是否已经存在内存中，如果存在则返回false，反之为true

2. 如果锁没有设置过期时间，加锁的服务刚好还没释放锁的时候宕机，导致其他服务无法获取到锁，一直轮询调用会造成其他服务崩溃。所以我们必须设置一个过期时间，保证这个锁必须自然释放。

   解决方案：设置过期时间

3. 释放锁的时候存在问题，因为释放锁的时候，都是同一个key，每个线程公用这个key。由于业务超时或者网络延迟，第一个线程超时了，第二个线程获取到锁，已经在处理业务；这个时候，第一个线程执行完业务，执行删除锁操作，就会删除调第二个线程使用的锁。所以我们必须在value值中设置一个唯一uuid号（如果出现碰撞可以使用雪花算法），用于区分每个线程调用的锁是不是属于你的。

   解决方案：每个线程执行的vlaue指定一个唯一的值

4. 由于释放锁的时候，查询value和比对value不是原子操作（即不是在redis上同时操作），由于网络存在传输延迟，导致获取value之后，还要在代码中执行删除操作，这个操作就有可能存在删除其他线程锁的问题。

   解决方案：使用lua

##### 修改方法

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 加入缓存</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;catalogJSON&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">            <span class="comment">// 缓存中没有，从数据库中取数据</span></span><br><span class="line">            catalogJson = getCatalogJsonFromDbWithDistributedLock();</span><br><span class="line">            <span class="keyword">return</span> catalogJson;</span><br><span class="line">        &#125;</span><br><span class="line">        catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本地锁,适用于单个服务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromDbWithLocalLock</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">        <span class="comment">// 本地进程保证只有一个线程进入查询数据库</span></span><br><span class="line">        <span class="comment">// TODO 分布式接口需要替换成分布式锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="comment">// 一次将所有数据查出来</span></span><br><span class="line">            catalogJson = getCatelogDataFromDb();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分布式锁,适用于多服务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJsonFromDbWithDistributedLock</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 本地进程保证只有一个线程进入查询数据库</span></span><br><span class="line">        <span class="comment">// 分布式接口需要替换成分布式锁</span></span><br><span class="line">        <span class="comment">// 占用分布式锁,去redis占坑</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="type">Boolean</span> <span class="variable">lock</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(<span class="string">&quot;lock&quot;</span>, uuid, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="comment">// 判断是否已经获取到锁</span></span><br><span class="line">        <span class="keyword">if</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 加锁成功,执行业务操作</span></span><br><span class="line">            <span class="comment">// 设置过期时间，必须和加锁是同步的，原子的</span></span><br><span class="line"><span class="comment">//            stringRedisTemplate.expire(&quot;lock&quot;,300,TimeUnit.SECONDS);</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                catalogJson = getCatelogDataFromDb();</span><br><span class="line">                <span class="keyword">return</span> catalogJson;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 使用lua脚本删除，原子操作</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">luaDelete</span> <span class="operator">=</span> <span class="string">&quot;if redis.call(\&quot;get\&quot;,KEYS[1]) == ARGV[1]\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;then\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    return redis.call(\&quot;del\&quot;,KEYS[1])\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    return 0\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end&quot;</span>;</span><br><span class="line">                <span class="type">Long</span> <span class="variable">lock1</span> <span class="operator">=</span> stringRedisTemplate.execute(<span class="keyword">new</span> <span class="title class_">DefaultRedisScript</span>&lt;Integer&gt;(luaDelete, Long.class),</span><br><span class="line">                        Arrays.asList(<span class="string">&quot;lock&quot;</span>), uuid);</span><br><span class="line">                System.out.println(<span class="string">&quot;删除分布式锁操作结果：&quot;</span> + lock1);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取值比对+比对成功删除=原子操作 lua脚本</span></span><br><span class="line"><span class="comment">//            String lockValue = stringRedisTemplate.opsForValue().get(&quot;lock&quot;);</span></span><br><span class="line"><span class="comment">//            if (uuid.equals(lockValue)) &#123;</span></span><br><span class="line"><span class="comment">//                // 比对成功删除自己的锁</span></span><br><span class="line"><span class="comment">//                stringRedisTemplate.delete(&quot;lock&quot;);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 获取不到锁,自旋调用</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait(<span class="number">100</span>);</span><br><span class="line">                <span class="keyword">return</span> getCatalogJsonFromDbWithDistributedLock();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatelogDataFromDb</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;缓存中不存在三级菜单数据,需要调用db查询&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;<span class="comment">// 一次将所有数据查出来</span></span><br><span class="line">        <span class="comment">// 进入到查询原子操作,再次执行缓存查询</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;catalogJSON&quot;</span>);</span><br><span class="line">        <span class="comment">// 不为空直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">            catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> catalogJson;</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;CategoryEntity&gt; all = baseMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// 查出所有一级分类</span></span><br><span class="line">        List&lt;CategoryEntity&gt; levelFirstCategorys = getItem(all, <span class="number">0L</span>);</span><br><span class="line">        catalogJson = levelFirstCategorys.stream().collect(Collectors.toMap(k -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> k.getCatId().toString();</span><br><span class="line">        &#125;, lv1 -&gt; &#123;</span><br><span class="line">            <span class="comment">// 每一个的一级分类，查到这个一级分类的二级分类</span></span><br><span class="line">            List&lt;CategoryEntity&gt; list2 = getItem(all, lv1.getParentCid());</span><br><span class="line">            List&lt;Catelog2Vo&gt; collect2 = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (list2 != <span class="literal">null</span>) &#123;</span><br><span class="line">                collect2 = list2.stream().map(lv2 -&gt; &#123;</span><br><span class="line">                    <span class="type">Catelog2Vo</span> <span class="variable">catelog2Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>(lv1.getCatId().toString(), <span class="literal">null</span>,</span><br><span class="line">                            lv2.getCatId().toString()</span><br><span class="line">                            , lv2.getName());</span><br><span class="line">                    List&lt;CategoryEntity&gt; list3 = getItem(all, lv2.getParentCid());</span><br><span class="line">                    <span class="keyword">if</span> (list3 != <span class="literal">null</span>) &#123;</span><br><span class="line">                        List&lt;Catelog2Vo.Catelog3Vo&gt; collect3 = list3.stream().map(lv3 -&gt; &#123;</span><br><span class="line">                            Catelog2Vo.<span class="type">Catelog3Vo</span> <span class="variable">catelog3Vo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Catelog2Vo</span>.Catelog3Vo(lv2.getCatId().toString(),</span><br><span class="line">                                    lv3.getCatId().toString(), lv3.getName());</span><br><span class="line">                            <span class="keyword">return</span> catelog3Vo;</span><br><span class="line">                        &#125;).collect(Collectors.toList());</span><br><span class="line">                        catelog2Vo.setCatalog3List(collect3);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> catelog2Vo;</span><br><span class="line">                &#125;).collect(Collectors.toList());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> collect2;</span><br><span class="line">        &#125;));</span><br><span class="line">        <span class="comment">// 查库,将结果同步至缓存,必须是一个原子操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;将db返回的结果同步到缓存中...&quot;</span>);</span><br><span class="line">        <span class="comment">// 查到的数据转为json对象放到缓存中</span></span><br><span class="line">        stringRedisTemplate.opsForValue().set(<span class="string">&quot;catalogJSON&quot;</span>, JSON.toJSONString(catalogJson), <span class="number">1</span>, TimeUnit.DAYS);</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



#### Redisson简介&整合

1. 引入依赖

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        使用redisson作为所有分布式锁，分布式对象等功能框架--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

2. 配置redisson

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRedissonConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(destroyMethod = &quot;shutdown&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> RedissonClient <span class="title function_">redisson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 创建配置</span></span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>();</span><br><span class="line">        <span class="comment">// 使用单体服务</span></span><br><span class="line">        config.useSingleServer().setAddress(<span class="string">&quot;redis://192.168.72.130:6379&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Redisson.create(config);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

3. 测试是否已经引入bean

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRedisson</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;redisson客户端：&quot;</span>+redissonClient);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



### Redisson

#### Redisson-lock锁测试

在测试TestController下添加内容

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RedissonClient redissonClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testRedisson&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRedisson</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 获取第一把锁,只要key值一样,就是同一把锁</span></span><br><span class="line">    <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(<span class="string">&quot;my-lock&quot;</span>);</span><br><span class="line">    <span class="comment">// 阻塞加锁</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="comment">// 默认加锁时间30s</span></span><br><span class="line">    <span class="comment">// 1.锁会自动续期,如果业务超长,运行期间自动给锁续上新的30s.不是担心业务时间过长,锁自动过期被删掉</span></span><br><span class="line">    <span class="comment">// 2.加锁的业务只要运行完成,就不会给当前锁续期,即使不手动续期,锁默认在30s以后自动删除</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;加锁成功,执行业务...&quot;</span>+Thread.currentThread().getId());</span><br><span class="line">        Thread.sleep(<span class="number">30000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;释放锁...&quot;</span>+Thread.currentThread().getId());</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;testRedisson&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



#### lock看门狗原理-reidisson 如何解决死锁

看门狗机制：自动为键值续期

1. lock.lock(10，TimeUnit.SECONS)； 在锁时间到了以后，不会自动续期，如果其他线程解锁会抛出异常；

   1.1 如果我们传递了锁的超时时间，就发送给redis执行脚本，进行占锁，默认超时就是我们只当的时间

   1.2 如果我们未指定锁的超时时间，就使用30*1000 【LockWatchdogTimeout看门狗的默认时间】

   ​	如果占锁成功，就会启动一个定时任务【重新给锁设置过期时间，新的过期时间就是看门狗的默认时间】，每个10s都会自动再次续期，续成30s

   ​	internallockLeaseTime【看门狗的默认时间】/ 3

注：最好的还是自定义过期时间



#### 读写锁测试

测试类TestController 加入以下内容：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">StringRedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testReadWriteLockForWrite&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testReadWriteLockForWrite</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RReadWriteLock</span> <span class="variable">testRWLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;testRWLock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> testRWLock.writeLock();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rLock.lock();</span><br><span class="line">        uuid = UUID.randomUUID().toString();</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;testRW&quot;</span>, uuid);</span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testReadWriteLockForRead&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testReadWriteLockForRead</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RReadWriteLock</span> <span class="variable">testRWLock</span> <span class="operator">=</span> redissonClient.getReadWriteLock(<span class="string">&quot;testRWLock&quot;</span>);</span><br><span class="line">    <span class="type">RLock</span> <span class="variable">rLock</span> <span class="operator">=</span> testRWLock.readLock();</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuid</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rLock.lock();</span><br><span class="line">        uuid = redisTemplate.opsForValue().get(<span class="string">&quot;testRW&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        rLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



#### 读写锁补充

保证一定能读到最新数据，修改期间，写锁是一个排他锁（互斥锁）。读锁是一个共享锁

写锁没释放读就必须等待

写 + 读：必须等待写锁释放

写 + 写：阻塞方式

读 + 读：相当于无锁，并发读，只会在redis中记录好，所有当前的读锁。他们都会同时加锁成功

读 + 写：有读锁。写也需要等待

只要有写的存在，都必须等待前面的锁释放



#### 闭锁测试

测试类TestController 加入以下内容：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testCountDownLatch/lockDoor&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testCountDownLatchForLockDoor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RCountDownLatch</span> <span class="variable">door</span> <span class="operator">=</span> redissonClient.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        door.trySetCount(<span class="number">3</span>);</span><br><span class="line">        door.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;班级全部人都走了...关门&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testCountDownLatch/goaway&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testCountDownLatchForGoAway</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RCountDownLatch</span> <span class="variable">door</span> <span class="operator">=</span> redissonClient.getCountDownLatch(<span class="string">&quot;door&quot;</span>);</span><br><span class="line">    door.countDown();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;有一个班级走了,还剩&quot;</span> + door.getCount() + <span class="string">&quot;个班级没走&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



#### 信号量测试

测试类TestController 加入以下内容：

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/testSemaphoreForPark&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testSemaphoreForPark</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redissonClient.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        park.acquire();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/testSemaphoreForGo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testSemaphoreForGo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">RSemaphore</span> <span class="variable">park</span> <span class="operator">=</span> redissonClient.getSemaphore(<span class="string">&quot;park&quot;</span>);</span><br><span class="line">    park.release();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

场景：分布式限流



### 缓存一致性解决

1. 双写模式

由于卡顿等原因，导致写缓存2在最前面，写缓存1在最后面就出现了不一致。

脏数据问题：这是暂时性的脏数据问题，但是在数据稳定，缓存过期以后，又能得到最新的正确数据。

读到的最新数据有延迟：最终一致性

2. 失效模式

解决方案：

无论是双写模式还是失效模式，都会导致缓存的不一致问题。即多个实例同时更新会出事。怎么办？

1. 如果是用户纬度数据（订单数据，用户数据），这种并发几率非常小，不用考虑这个问题，缓存数据加上过期事件，每隔一段时间触发读的主动更新即可。
2. 如果是菜单，商品介绍等基础数据，也可以去使用canal订阅binlog的方式。
3. 缓存数据+过期时间也足够解决大部分业务对于缓存的要求。
4. 通过加锁保证并发读写，写写的时候按顺序排好队。读读无所谓。所以适合使用读写锁。（业务不关心脏数据，允许临时的脏数据可忽略）

总结：

1. 我们能放入缓存的数据本就不应该是实时性、一致性要求超高的。所以缓存数据的时候加上过期时间，保证每天拿到当前最新数据即可。
2. 我们不应该过度设计，增加系统的复杂性。
3. 遇到实时性、一致性要求高的数据，就应该查数据库，即使慢点。

##### Canal

1. 根据订阅binlog，更新redis
2. 解决数据异构，分析用户兴趣爱好，生成另外一张表，例如：用户推荐表



### SpringCache

#### 简介

1. Spring从3.1开始定义了org.springframework.cache.Cache 和 org.springframework.cache.CacheManeger 接口来统一不同的缓存技术；并支持使用JCache(JSR-107)注解简化我们开发；

2. Cache接口为缓存的组件规范定义，包含缓存的各种操作集合；Cache接口下Spring提供各种xxxCache的实现；如：RedisCache，EhCacheCache，ConcurrentMapCache等；
3. 每次调用需要缓存功能的方法时，Spring会检查指定参数的指定目标方法是否已经被调用过；如果有就直接从缓存中获取方法调用后的结果，如果没有就调用方法缓存结果后返回给用户。下次调用直接从缓存中获取。
4. 使用Spring缓存抽象时我们需要关注以下两点：
   1. 确定方法需要被缓存以及他们的缓存策略；
   2. 从缓存中读取之前缓存存储的数据；



#### 整体&体验@Cacheable

1. 引入依赖

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

2. 加入配置，CacheAutoConfiguration会导入RedisCacheConfiguration，自动配置好了缓存管理器RedisCacheManager

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用redis缓存</span></span><br><span class="line"><span class="attr">spring.cache.type</span>=<span class="string">redis</span></span><br></pre></td></tr></table></figure>

3. 使用

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每一个需要缓存的数据我们都来指定要放到那个名字的缓存</span></span><br><span class="line"><span class="meta">@Cacheable(&#123;&quot;category&quot;&#125;)</span> <span class="comment">// 代表当前方法的结果需要缓存，如果缓存中有,方法不用调用。如果缓存中没有，会调用方法，最后将方法的返回值缓存。</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevelFirstCategorys</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;CategoryEntity&gt; list = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



#### @Cacheable细节设置

##### 默认行为

1. 如果缓存中有，方法不用调用
2. key默认自动生成；缓存的名字；SimpleKey [] (自动生成的key值)
3. 缓存的value的值。默认使用jdk序列化机制，将序列化的数据存到redis
4. 默认事件 -1；

##### 自定义

1. 指定生成的缓存使用的key

   key属性指定，接受一个SpEL

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;&#x27;levelFirstCategorys&#x27;&quot;)</span><br></pre></td></tr></table></figure>

   使用方法名为key

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Cacheable(value = &#123;&quot;category&quot;&#125;,key = &quot;#root.method.name&quot;)</span><br></pre></td></tr></table></figure>

2. 指定缓存的数据的存活时间

   统一设置存活时间，在配置文件中配置，是以毫秒为单位

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.cache.redis.time-to-live=6000</span><br></pre></td></tr></table></figure>

3. 将数据保存为json格式



#### 自定义缓存设置

1. CacheAutoConfiguration 导入了 RedisCacheConfiguration ，自动配置了RedisCacheManager，初始化所有的缓存，每个缓存决定使用什么配置，如果redisCacheConfiguration有就用已有的，没有就用默认配置，想改缓存的配置，只需要给容器中放一个RedisCacheConfiguration即可，就会应用到当前RedisCacheManager管理的所有缓存分区中。
2. 建立一个MyCacheConfig，修改默认序列化配置

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@EnableConfigurationProperties(CacheProperties.class)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCacheConfig</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Autowired</span></span><br><span class="line"><span class="comment">//    CacheProperties cacheProperties;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    RedisCacheConfiguration <span class="title function_">redisCacheConfiguration</span><span class="params">(CacheProperties cacheProperties)</span> &#123;</span><br><span class="line">        <span class="type">RedisCacheConfiguration</span> <span class="variable">config</span> <span class="operator">=</span> RedisCacheConfiguration.defaultCacheConfig();</span><br><span class="line"><span class="comment">//        config = config.entryTtl();</span></span><br><span class="line">        <span class="comment">//key的序列化</span></span><br><span class="line">        config =</span><br><span class="line">                config.serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>()));</span><br><span class="line">        <span class="comment">//value的序列化</span></span><br><span class="line">        config =</span><br><span class="line">                config.serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>()));</span><br><span class="line">        CacheProperties.<span class="type">Redis</span> <span class="variable">redisProperties</span> <span class="operator">=</span> cacheProperties.getRedis();</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getTimeToLive() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.entryTtl(redisProperties.getTimeToLive());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (redisProperties.getKeyPrefix() != <span class="literal">null</span>) &#123;</span><br><span class="line">            config = config.prefixKeysWith(redisProperties.getKeyPrefix());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isCacheNullValues()) &#123;</span><br><span class="line">            config = config.disableCachingNullValues();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!redisProperties.isUseKeyPrefix()) &#123;</span><br><span class="line">            config = config.disableKeyPrefix();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

3. 加入Cache的一些自定义配置。

<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#设置缓存时间</span></span><br><span class="line"><span class="attr">spring.cache.redis.time-to-live</span>=<span class="string">600000</span></span><br><span class="line"><span class="comment">#key的前缀，如果指定了前缀就用我们指定的前缀，如果没有就默认使用缓存的名字作为前缀</span></span><br><span class="line"><span class="comment">#spring.cache.redis.key-prefix=CACHE_</span></span><br><span class="line"><span class="comment">#缓存的前缀是否使用</span></span><br><span class="line"><span class="attr">spring.cache.redis.use-key-prefix</span>=<span class="string">true</span></span><br><span class="line"><span class="comment">#是否缓存空值 解决缓存穿透</span></span><br><span class="line"><span class="attr">spring.cache.redis.cache-null-values</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>



#### @CacheEvict

##### 从缓存中删除数据

1. 使用@Caching 组合操作进行操作

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Caching(evict = &#123;@CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getLevelFirstCategory&#x27;&quot;),@CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)&#125;)</span><br></pre></td></tr></table></figure>

2. 指定删除某个分区下的所有数据

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@CacheEvict(value = &quot;category&quot; , allEntries = true)</span><br></pre></td></tr></table></figure>

3. 存储同一类型的数据，都可以指定成同一个分区。分区名默认就是缓存的前缀

4. @CachePut 使用双写模式
5. 修改之前的逻辑

CategoryServiceImpl

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 级联更新所有关联的数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> category</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Caching(evict = &#123;@CacheEvict(value = &quot;category&quot;, key = &quot;&#x27;getLevelFirstCategorys&#x27;&quot;), @CacheEvict(value =</span></span><br><span class="line"><span class="meta">            &quot;category&quot;, key = &quot;&#x27;getCatalogJson&#x27;&quot;)&#125;)</span></span><br><span class="line"><span class="comment">//    @CacheEvict(value = &quot;category&quot; , allEntries = true)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateCascade</span><span class="params">(CategoryEntity category)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.updateById(category);</span><br><span class="line">        categoryBrandRelationService.updateCategory(category.getCatId(), category.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 每一个需要缓存的数据我们都来指定要放到那个名字的缓存</span></span><br><span class="line">    <span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;#root.methodName&quot;)</span> <span class="comment">// 代表当前方法的结果需要缓存，如果缓存中有,方法不用调用。如果缓存中没有，会调用方法，最后将方法的返回值缓存。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;CategoryEntity&gt; <span class="title function_">getLevelFirstCategorys</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;CategoryEntity&gt; list = baseMapper.selectList(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;CategoryEntity&gt;().eq(<span class="string">&quot;parent_cid&quot;</span>, <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Cacheable(value = &#123;&quot;category&quot;&#125;, key = &quot;#root.methodName&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, List&lt;Catelog2Vo&gt;&gt; <span class="title function_">getCatalogJson</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 加入缓存</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">catalogJSON</span> <span class="operator">=</span> stringRedisTemplate.opsForValue().get(<span class="string">&quot;getCatalogJson&quot;</span>);</span><br><span class="line">        Map&lt;String, List&lt;Catelog2Vo&gt;&gt; catalogJson;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(catalogJSON)) &#123;</span><br><span class="line">            <span class="comment">// 缓存中没有，从数据库中取数据</span></span><br><span class="line">            catalogJson = getCatalogJsonFromDbWithDistributedLock();</span><br><span class="line">            <span class="keyword">return</span> catalogJson;</span><br><span class="line">        &#125;</span><br><span class="line">        catalogJson = JSON.parseObject(catalogJSON, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, List&lt;Catelog2Vo&gt;&gt;&gt;() &#123;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> catalogJson;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



#### 原理与不足

##### Spring-Cache不足

1. 读模式

   缓存穿透：查询一个null数据。解决：缓存空数据；cache-null-value=true

   缓存击穿：大量并发进来同时查询一个正好过期的数据。解决：加锁；？默认是没有加锁的；在注解中加入sync=true属性（加锁，解决击穿）

   缓存雪崩：大量的key同时过期。解决：加随机时间。加上过期时间。spring.cache.redis.time-to-live=600000

2. 写模式（缓存与数据库一致）

   2.1 读写加锁

   2.2 引入Canal，感知到MySql的更新操作去更新缓存

   2.3 读多写多，直接去数据库查询。

总结：

常规数据（读多写少，即时性，一致性要求不高的数据）；完全可以使用Spring-Cache

特殊数据：特殊设计

##### 原理

​	CacheManager（RedisCacheManager） ——》Cache ——》Cache负责缓存的读写

​	查看RedisCache源码





## 商城业务

### 检索服务

#### 搭建页面环境

1. 在ES模块引入模板引擎
2. 将index.html加入资源文件template文件夹下，文件头引入名称空间，<html lang="en" xmlns:th="http://www.thymeleaf.org">
3. href=" 替换 href="/static/search/  ，src=" 替换 src="/static/search/
4. hosts 加入 域名映射配置

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.72.130 search.supermall.com</span><br></pre></td></tr></table></figure>

5. 修改nginx配置

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server_name  supermall.com *.supermall.com; #主机名、域名</span><br></pre></td></tr></table></figure>

6. 配置网关配置

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- id: super_mall_search_host_route</span><br><span class="line">  uri: lb://supermall-elasticsearch</span><br><span class="line">  predicates:</span><br><span class="line">    - Host=search.supermall.com    </span><br></pre></td></tr></table></figure>

   

#### 调试页面跳转

1. 调试搜索页面跳转首页

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;http://supermall.com&quot;&gt;&lt;img src=&quot;/static/search/image/logo1.jpg&quot; alt=&quot;&quot;&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>

2. 新建listPage 跳转方法，把index.html改成list.html

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">listPage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

3. 修改catalogLoder.js 文件，然后上传到nginx对应的文件夹下

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var cata3link = $(&quot;&lt;a href=\&quot;http://&#123;自己定义的域名&#125;/list.html?catalog3Id=&quot;+ctg3.id+&quot;\&quot; style=\&quot;color: #999;\&quot;&gt;&quot; + ctg3.name + &quot;&lt;/a&gt;&quot;);</span><br></pre></td></tr></table></figure>

4. 修改搜索方法的跳转元素

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;javascript:search();&quot; &gt;&lt;img src=&quot;/static/index/img/img_09.png&quot; /&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>

5. 修改跳转方法

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function search() &#123;</span><br><span class="line">    var keyword=$(&quot;#searchText&quot;).val()</span><br><span class="line">    window.location.href=&quot;http://search.supermall.com/list.html?keyword=&quot;+keyword;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

   



#### 检索查询参数模型分析抽取

1. 创建商城检索服务和接收检索的实体类

   MallSearchService.java

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *</span><br><span class="line"> * @param searchParam 检索的所有参数</span><br><span class="line"> * @return</span><br><span class="line"> */</span><br><span class="line">Object search(SearchParam searchParam);</span><br></pre></td></tr></table></figure>

   SearchController.java

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MallSearchService mallSearchService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自动将页面提交过来的所有请求参数封装成指定的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> searchParam</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">listPage</span><span class="params">(SearchParam searchParam)</span>&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">search</span> <span class="operator">=</span> mallSearchService.search(searchParam);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

   SearchParam.java

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchParam</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页面传递过来的全文匹配关键字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyword;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 三级分类id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long catalog3Id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 排序条件</span></span><br><span class="line"><span class="comment">     * sort=saleCount_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=skuPrice_asc/desc</span></span><br><span class="line"><span class="comment">     * sort=hotScore_asc/desc</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String sort;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 过滤条件</span></span><br><span class="line"><span class="comment">     * hasStock(是否有货),skuPrice区间,brandId,catalog3Id,attrs</span></span><br><span class="line"><span class="comment">     * hasStock=0/1</span></span><br><span class="line"><span class="comment">     * skuPrice=1_500/_500/500_</span></span><br><span class="line"><span class="comment">     * brandId=1</span></span><br><span class="line"><span class="comment">     * attrs=2_5寸:6寸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否只显示有货</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer hasStock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 价格区间查询</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String skuPrice;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 品牌id 支持多选</span></span><br><span class="line"><span class="comment">     * 如何多拼</span></span><br><span class="line"><span class="comment">     * brandId=1&amp;brandId=2</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Long&gt; brandId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

   1.1 商品检索分为三个入口：

   1. 选择分类进入商品检索

   2. 输入检索关键字展示检索页

   3. 选择筛选条件进入（最复杂）

      3.1 商城检索-检索条件分析

      1. 全文检索：skuTitle
      2. 排序：saleCount（销量），hotScore人（热度），skuPrice（价格）
      3. 过滤：hasStock，skuPrice区间，brandId，catalog3Id，attrs
      4. 聚合：attrs

      3.2 一个完整的查询

      <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keyword=小米&amp;sort=saleCount_desc/asc&amp;hasStock=0/1&amp;skuPrice=400_1900&amp;brandId=1&amp;catalog3Id=1&amp;attrs=1_3G:4G:5G&amp;attrs=2_骁龙845&amp;attrs=4_高清屏</span><br></pre></td></tr></table></figure>

      

#### 检索返回结果模型分析抽取

1. 新建返回对象 SearchResults.java

   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResults</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询到的所有商品信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SkuEsModel&gt; products;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前查询到的结果，涉及所有品牌信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;BrandVo&gt; brands;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 涉及到的所有属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;AttrVo&gt; attrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 涉及到的所有分类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;CatalogVo&gt; catalogs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============一下是分页信息=====================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前页面</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pageNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总记录数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long total;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 总页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer totalPages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============以上是返回到页面的所有信息=================</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">BrandVo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long brandId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String brandName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String brandImg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AttrVo</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long attrId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String attrName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; attrValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">CatalogVo</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long catalogId;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String catalogName;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

   2. 修改SearchController

      <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自动将页面提交过来的所有请求参数封装成指定的对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> searchParam</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/list.html&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">listPage</span><span class="params">(SearchParam searchParam, Model model)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据传递来的页面的查询参数,去ES中检索商品</span></span><br><span class="line">    <span class="type">SearchResults</span> <span class="variable">results</span> <span class="operator">=</span> mallSearchService.search(searchParam);</span><br><span class="line">    model.addAttribute(<span class="string">&quot;result&quot;</span>,results);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;list&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





#### 检索DSL测试

##### 查询部分

使用kibana管理界面测试检索内容，测试命令如下:

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">GET product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;skuTitle&quot;: &quot;华为&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;catalogId&quot;: &quot;225&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;brandId&quot;: [</span><br><span class="line">              &quot;1&quot;,</span><br><span class="line">              &quot;2&quot;,</span><br><span class="line">              &quot;9&quot;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;nested&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;attrs&quot;,</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">              &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;term&quot;: &#123;</span><br><span class="line">                      &quot;attrs.attrId&quot;: &#123;</span><br><span class="line">                        &quot;value&quot;: &quot;15&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;terms&quot;: &#123;</span><br><span class="line">                      &quot;attrs.attrValue&quot;: [</span><br><span class="line">                        &quot;海斯&quot;,</span><br><span class="line">                        &quot;以官网消息为准&quot;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;hasStock&quot;: &#123;</span><br><span class="line">              &quot;value&quot;: &quot;true&quot;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;range&quot;: &#123;</span><br><span class="line">            &quot;skuPrice&quot;: &#123;</span><br><span class="line">              &quot;gte&quot;: 0,</span><br><span class="line">              &quot;lte&quot;: 60000</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;skuPrice&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 20,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;&quot;skuTitle&quot;: &#123;&#125;&#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/b&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

1. must 中的条件参与评分，filter中的条件不参与；
2. must 中一般是keyword字段中带出的字符串；
3. 范围检索range
4. 分页用from和size
5. 关键字高亮highlight，配置需要高亮的字段，例如：skuTittle ，使用pre_tags配置前缀拼接，post_tags配置后置拼接。



##### 聚合部分

使用aggs进行聚合分析

在结果中的aggregations字段下存在聚合的结果，聚合中的结果key则为聚合的结果值，doc_count则为命中的条数。

使用子聚合查询聚合结果中的详细内容

由于之前做brandName字段不做检索 index=false和 doc_values = false；

因为需要修改映射值，所以必须重新创建一个索引，然后重新创建映射，然后再把数据导入到新的映射中去。

修改es服务中的EsConstant文件PRODUCT_INDEX常量为刚刚新建的映射索引。

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">#聚合数据</span><br><span class="line">GET supermall_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;brand_agg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;brandId&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;brand_name_agg&quot;: &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brandName&quot;,</span><br><span class="line">            &quot;size&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;brand_img_agg&quot;:&#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;field&quot;: &quot;brandImg&quot;,</span><br><span class="line">            &quot;size&quot;: 10</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;catalog_agg&quot;: &#123;</span><br><span class="line">      &quot;terms&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;catalogId&quot;,</span><br><span class="line">        &quot;size&quot;: 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#迁移数据 </span><br><span class="line">#从product映射迁移到supermall_product映射</span><br><span class="line">POST _reindex</span><br><span class="line">&#123;</span><br><span class="line">  &quot;source&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;product&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;dest&quot;: &#123;</span><br><span class="line">    &quot;index&quot;: &quot;supermall_product&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#查询</span><br><span class="line">GET supermall_product/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;bool&quot;: &#123;</span><br><span class="line">      &quot;must&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;match&quot;: &#123;</span><br><span class="line">            &quot;skuTitle&quot;: &quot;华为&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      &quot;filter&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;term&quot;: &#123;</span><br><span class="line">            &quot;catalogId&quot;: 225</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;terms&quot;: &#123;</span><br><span class="line">            &quot;brandId&quot;: [</span><br><span class="line">              &quot;4&quot;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;nested&quot;: &#123;</span><br><span class="line">            &quot;path&quot;: &quot;attrs&quot;,</span><br><span class="line">            &quot;query&quot;: &#123;</span><br><span class="line">              &quot;bool&quot;: &#123;</span><br><span class="line">                &quot;must&quot;: [</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;term&quot;: &#123;</span><br><span class="line">                      &quot;attrs.attrId&quot;: &#123;</span><br><span class="line">                        &quot;value&quot;: &quot;1&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;,</span><br><span class="line">                  &#123;</span><br><span class="line">                    &quot;terms&quot;: &#123;</span><br><span class="line">                      &quot;attrs.attrValue&quot;: [</span><br><span class="line">                        &quot;OLED&quot;,</span><br><span class="line">                        &quot;护眼模式&quot;</span><br><span class="line">                      ]</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sort&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;skuPrice&quot;: &#123;</span><br><span class="line">        &quot;order&quot;: &quot;desc&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;from&quot;: 0,</span><br><span class="line">  &quot;size&quot;: 20,</span><br><span class="line">  &quot;highlight&quot;: &#123;</span><br><span class="line">    &quot;fields&quot;: &#123;</span><br><span class="line">      &quot;skuTitle&quot;: &#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;pre_tags&quot;: &quot;&lt;b style=&#x27;color:red&#x27;&gt;&quot;,</span><br><span class="line">    &quot;post_tags&quot;: &quot;&lt;/b&gt;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/ES/">#ES</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2023/03/24/Java-8-stream/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Java 8 stream</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/03/24/%E5%88%86%E5%B8%83%E5%BC%8F%E7%94%B5%E5%95%86%E9%A1%B9%E7%9B%AE-%E5%9F%BA%E7%A1%80%E7%AF%87/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">分布式电商项目-基础篇</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            


        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2023</span>
              -
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">center-sept</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        访问人数&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        总访问量&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        
            <li class="tools-item rss flex-center">
                <a class="flex-center"
                   href="/atom.xml"
                   target="_blank"
                >
                    <i class="fas fa-rss"></i>
                </a>
            </li>
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">1.</span> <span class="nav-text">全文检索</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ElasticSearch"><span class="nav-number">1.1.</span> <span class="nav-text">ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">简介</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-index-%E7%B4%A2%E5%BC%95"><span class="nav-number">1.1.1.1.1.</span> <span class="nav-text">1.index (索引)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-Type-%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.1.1.1.2.</span> <span class="nav-text">2.Type (类型)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-Document-%E6%96%87%E6%A1%A3"><span class="nav-number">1.1.1.1.3.</span> <span class="nav-text">3.Document (文档)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95%E6%9C%BA%E5%88%B6"><span class="nav-number">1.1.1.1.4.</span> <span class="nav-text">4.倒排索引机制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker%E5%AE%89%E8%A3%85ES"><span class="nav-number">1.1.2.</span> <span class="nav-text">Docker安装ES</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">1.下载镜像文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BE%8B"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">2.创建实例</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Docker%E5%AE%89%E8%A3%85Kibana"><span class="nav-number">1.1.3.</span> <span class="nav-text">Docker安装Kibana</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A5%E9%97%A8"><span class="nav-number">1.1.4.</span> <span class="nav-text">入门</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#cat-%E6%9F%A5%E7%9C%8BES%E4%BF%A1%E6%81%AF"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">_cat (查看ES信息)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#put-amp-post%E6%96%B0%E5%A2%9E%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.4.2.</span> <span class="nav-text">put&amp;post新增数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#get%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE-amp-%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">1.1.4.3.</span> <span class="nav-text">get查询数据&amp;乐观锁</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#get%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.4.3.1.</span> <span class="nav-text">get查询数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">1.1.4.3.2.</span> <span class="nav-text">乐观锁</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#put-amp-post%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.4.4.</span> <span class="nav-text">put&amp;post修改数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE-amp-bulk%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.4.5.</span> <span class="nav-text">删除数据&amp;bulk批量操作</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="nav-number">1.1.4.5.1.</span> <span class="nav-text">删除文档</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#bulk%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C"><span class="nav-number">1.1.4.5.2.</span> <span class="nav-text">bulk批量操作</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E5%AE%A2%E6%88%B7%E9%93%B6%E8%A1%8C%E5%AE%A2%E6%88%B7%E6%A0%B7%E6%9C%AC%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.4.5.3.</span> <span class="nav-text">导入客户银行客户样本测试数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9B%E9%98%B6"><span class="nav-number">1.1.5.</span> <span class="nav-text">进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E6%9F%A5%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.5.1.</span> <span class="nav-text">两种查询方式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#SearchAPI"><span class="nav-number">1.1.5.1.1.</span> <span class="nav-text">SearchAPI</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#uri-%E6%A3%80%E7%B4%A2%E5%8F%82%E6%95%B0"><span class="nav-number">1.1.5.1.2.</span> <span class="nav-text">uri+检索参数</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#uri-%E6%A3%80%E7%B4%A2%E5%8F%82%E6%95%B0%EF%BC%88QueryDSL%E6%96%B9%E5%BC%8F%EF%BC%89"><span class="nav-number">1.1.5.1.3.</span> <span class="nav-text">uri+检索参数（QueryDSL方式）</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#QueryDSL%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8-amp-match-all"><span class="nav-number">1.1.5.2.</span> <span class="nav-text">QueryDSL基本使用&amp;match_all</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#match%E5%85%A8%E6%96%87%E6%A3%80%E7%B4%A2"><span class="nav-number">1.1.5.3.</span> <span class="nav-text">match全文检索</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#match-parase%E7%9F%AD%E8%AF%AD%E5%8C%B9%E9%85%8D"><span class="nav-number">1.1.5.4.</span> <span class="nav-text">match_parase短语匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#multi-match%E5%A4%9A%E5%AD%97%E6%AE%B5%E5%8C%B9%E9%85%8D"><span class="nav-number">1.1.5.5.</span> <span class="nav-text">multi_match多字段匹配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#bool%E5%A4%8D%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.1.5.6.</span> <span class="nav-text">bool复合查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#filter-%E7%BB%93%E6%9E%9C%E8%BF%87%E6%BB%A4"><span class="nav-number">1.1.5.7.</span> <span class="nav-text">filter (结果过滤)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#term-%E6%9F%A5%E8%AF%A2"><span class="nav-number">1.1.5.8.</span> <span class="nav-text">term 查询</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#aggregations-%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90"><span class="nav-number">1.1.5.9.</span> <span class="nav-text">aggregations 聚合分析</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%98%A0%E5%B0%84"><span class="nav-number">1.1.6.</span> <span class="nav-text">映射</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mapping%E5%88%9B%E5%BB%BA"><span class="nav-number">1.1.6.1.</span> <span class="nav-text">mapping创建</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMapping-%E6%98%A0%E5%B0%84-%EF%BC%9F"><span class="nav-number">1.1.6.1.1.</span> <span class="nav-text">什么是Mapping(映射)？</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E5%AD%97%E6%AE%B5%E6%98%A0%E5%B0%84"><span class="nav-number">1.1.6.2.</span> <span class="nav-text">添加新的字段映射</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%98%A0%E5%B0%84-amp-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="nav-number">1.1.6.3.</span> <span class="nav-text">修改映射&amp;数据迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%98%A0%E5%B0%84"><span class="nav-number">1.1.6.3.1.</span> <span class="nav-text">更新映射</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="nav-number">1.1.6.3.2.</span> <span class="nav-text">数据迁移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%86%E8%AF%8D"><span class="nav-number">1.1.7.</span> <span class="nav-text">分词</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%86%E8%AF%8D-amp-%E5%AE%89%E8%A3%85ik%E5%88%86%E8%AF%8D"><span class="nav-number">1.1.7.1.</span> <span class="nav-text">分词&amp;安装ik分词</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%BD%95%E4%B8%BA%E5%88%86%E8%AF%8D%E5%99%A8%EF%BC%9F"><span class="nav-number">1.1.7.1.1.</span> <span class="nav-text">何为分词器？</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95%E8%AF%8D%E5%BA%93"><span class="nav-number">1.1.7.2.</span> <span class="nav-text">自定义扩展词库</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E4%B8%BA%E4%BD%95%E9%9C%80%E8%A6%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95%E8%AF%8D%E5%BA%93%EF%BC%9F"><span class="nav-number">1.1.7.2.1.</span> <span class="nav-text">为何需要自定义扩展词库？</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AF%8D%E5%BA%93"><span class="nav-number">1.1.7.2.2.</span> <span class="nav-text">自定义词库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88"><span class="nav-number">1.1.8.</span> <span class="nav-text">整合</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88high-level-client"><span class="nav-number">1.1.8.1.</span> <span class="nav-text">SpringBoot整合high-level-client</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#java%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">1.1.8.1.1.</span> <span class="nav-text">java客户端</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%BC%95%E5%85%A5Elasticsearch-Rest-Client"><span class="nav-number">1.1.8.1.2.</span> <span class="nav-text">引入Elasticsearch-Rest-Client</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BF%9D%E5%AD%98"><span class="nav-number">1.1.8.2.</span> <span class="nav-text">测试保存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%A4%8D%E6%9D%82%E6%A3%80%E7%B4%A2"><span class="nav-number">1.1.8.3.</span> <span class="nav-text">测试复杂检索</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%86%E5%9F%8E%E4%B8%9A%E5%8A%A1"><span class="nav-number">2.</span> <span class="nav-text">商城业务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6"><span class="nav-number">2.1.</span> <span class="nav-text">商品上架</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#sku%E5%9C%A8es%E4%B8%AD%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.1.1.</span> <span class="nav-text">sku在es中存储模型分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%95%86%E5%9F%8Emapping"><span class="nav-number">2.1.1.1.</span> <span class="nav-text">商城mapping</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E5%88%86%E6%9E%90%EF%BC%9A%E5%95%86%E5%93%81%E4%B8%8A%E6%9E%B6%E5%9C%A8es%E4%B8%AD%E6%98%AF%E5%AD%98sku%E8%BF%98%E6%98%AFspu-%EF%BC%9F"><span class="nav-number">2.1.1.1.1.</span> <span class="nav-text">分析：商品上架在es中是存sku还是spu ？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nested%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%9C%BA%E6%99%AF"><span class="nav-number">2.1.2.</span> <span class="nav-text">nested数据类型场景</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Es-%E6%95%B0%E7%BB%84%E7%9A%84%E6%89%81%E5%B9%B3%E5%8C%96%E5%A4%84%E7%90%86"><span class="nav-number">2.1.2.1.</span> <span class="nav-text">Es-数组的扁平化处理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.3.</span> <span class="nav-text">构造基本数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%84%E9%80%A0sku%E6%A3%80%E7%B4%A2%E6%95%B0%E6%8D%AE"><span class="nav-number">2.1.4.</span> <span class="nav-text">构造sku检索数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E6%9F%A5%E8%AF%A2%E5%BA%93%E5%AD%98-amp-%E6%B3%9B%E5%9E%8B%E7%BB%93%E6%9E%9C%E5%B0%81%E8%A3%85"><span class="nav-number">2.1.5.</span> <span class="nav-text">远程查询库存&amp;泛型结果封装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9C%E7%A8%8B%E4%B8%8A%E6%9E%B6%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.1.6.</span> <span class="nav-text">远程上架接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%8A%E6%9E%B6%E6%8E%A5%E5%8F%A3%E8%B0%83%E8%AF%95-amp-feign%E6%BA%90%E7%A0%81"><span class="nav-number">2.1.7.</span> <span class="nav-text">上架接口调试&amp;feign源码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8A%BD%E5%8F%96%E5%93%8D%E5%BA%94%E7%BB%93%E6%9E%9C-amp-%E4%B8%8A%E6%9E%B6%E6%B5%8B%E8%AF%95%E5%AE%8C%E6%88%90"><span class="nav-number">2.1.8.</span> <span class="nav-text">抽取响应结果&amp;上架测试完成</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A6%96%E9%A1%B5"><span class="nav-number">2.2.</span> <span class="nav-text">首页</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88thymeleaf%E6%B8%B2%E6%9F%93%E9%A6%96%E9%A1%B5"><span class="nav-number">2.2.1.</span> <span class="nav-text">整合thymeleaf渲染首页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B4%E5%90%88dev-tools%E6%B8%B2%E6%9F%93%E4%B8%80%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"><span class="nav-number">2.2.2.</span> <span class="nav-text">整合dev-tools渲染一级分类数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E4%BA%8C%E7%BA%A7%E5%92%8C%E4%B8%89%E7%BA%A7%E5%88%86%E7%B1%BB%E6%95%B0%E6%8D%AE"><span class="nav-number">2.2.3.</span> <span class="nav-text">渲染二级和三级分类数据</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nginx"><span class="nav-number">2.3.</span> <span class="nav-text">nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E7%8E%AF%E5%A2%83%E4%B8%80%EF%BC%88%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">2.3.1.</span> <span class="nav-text">搭建域名访问环境一（反向代理配置）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">2.3.1.1.</span> <span class="nav-text">正向代理与反向代理</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E5%9F%9F%E5%90%8D%E8%AE%BF%E9%97%AE%E7%8E%AF%E5%A2%83%E4%BA%8C%EF%BC%88%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%88%B0%E7%BD%91%E5%85%B3%EF%BC%89"><span class="nav-number">2.3.2.</span> <span class="nav-text">搭建域名访问环境二（负载均衡到网关）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B"><span class="nav-number">3.</span> <span class="nav-text">性能压测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="nav-number">3.1.</span> <span class="nav-text">压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="nav-number">3.1.1.</span> <span class="nav-text">基本介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="nav-number">3.1.1.1.</span> <span class="nav-text">性能指标</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Apache-JMeter%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">Apache JMeter安装使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JMeter%E5%9C%A8windows%E4%B8%8B%E5%9C%B0%E5%9D%80%E5%8D%A0%E7%94%A8bug%E8%A7%A3%E5%86%B3"><span class="nav-number">3.1.3.</span> <span class="nav-text">JMeter在windows下地址占用bug解决</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JMeter-Address-Already-in-user-%E9%94%99%E8%AF%AF%E8%A7%A3%E5%86%B3"><span class="nav-number">3.1.3.1.</span> <span class="nav-text">JMeter Address Already in user 错误解决</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7"><span class="nav-number">3.2.</span> <span class="nav-text">性能监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6"><span class="nav-number">3.2.1.</span> <span class="nav-text">堆内存与垃圾回收</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jconsole%E4%B8%8Ejvisualvm"><span class="nav-number">3.2.2.</span> <span class="nav-text">jconsole与jvisualvm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#jvisualvm%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">jvisualvm能干什么？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6%E6%96%B9%E4%BE%BF%E6%9F%A5%E7%9C%8BGC"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">安装插件方便查看GC</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E5%8C%96"><span class="nav-number">3.3.</span> <span class="nav-text">优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AF%B9%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">3.3.1.</span> <span class="nav-text">中间件对性能的影响</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BC%98%E5%8C%96%E5%90%9E%E5%90%90%E9%87%8F%E6%B5%8B%E8%AF%95"><span class="nav-number">3.3.2.</span> <span class="nav-text">简单优化吞吐量测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="nav-number">3.3.3.</span> <span class="nav-text">nginx动静分离</span></a></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>





    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/lazyload.js"></script>


<div class="post-scripts pjax">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/pjax.min.js"></script>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



</body>
</html>
